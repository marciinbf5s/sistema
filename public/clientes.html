<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clientes - Sistema de Gestão Clínica</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="css/sidebar.css" rel="stylesheet">
    <link href="css/theme.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #f0b354;    /* Dourado */
            --primary-hover: #d9a24a;   /* Dourado mais escuro */
            --secondary-color: #041a31; /* Azul Royal */
            --secondary-hover: #031425; /* Azul Royal mais escuro */
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --border-color: rgba(240, 179, 84, 0.2);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover, .btn-primary:focus {
            background-color: var(--primary-hover);
            border-color: var(--primary-hover);
        }
        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .table-hover > tbody > tr:hover {
            background-color: #f5f7fa !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
        }
        
        .page-title {
            color: var(--secondary-color);
            font-weight: 600;
        }
        
        .table > :not(:last-child) > :last-child > * {
            border-bottom-color: #e0e0e0;
            border-bottom-width: 2px;
        }
        
        .table-striped > tbody > tr:nth-of-type(odd) {
            background-color: #f9fafb;
        }
        
        .table-striped > tbody > tr:nth-of-type(even) {
            background-color: #ffffff;
        }
        
        .table > thead th {
            border-top: none;
            border-bottom: 2px solid #ced4da !important;
            padding: 1.1rem 1.5rem;
            font-weight: 700 !important;
            color: #000000 !important;
            background-color: #e9ecef !important;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background-color: #f8f9fa;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
        }
        
        .table > tbody > tr {
            border-bottom: 1px solid #e8e9ea;
            transition: background-color 0.15s ease;
        }
        
        .table > tbody > tr:hover {
            background-color: #f8f9fa;
        }
        
        .table td {
            padding: 1.1rem 1.5rem;
            vertical-align: middle;
            border-top: 1px solid #f0f0f0;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
            justify-content: center;
        }
        
        .action-buttons .btn {
            width: 32px;
            height: 32px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            border-radius: 4px;
            transition: all 0.2s ease;
            margin: 0 2px;
            border-width: 1px;
        }
        
        /* Botão Visualizar - Verde suave */
        .action-buttons .btn-outline-primary {
            color: #2e7d32;
            border-color: #a5d6a7;
            background-color: #e8f5e9;
        }
        
        .action-buttons .btn-outline-primary:hover {
            background-color: #2e7d32;
            color: white;
            border-color: #2e7d32;
        }
        
        /* Botão Editar - Amarelo suave */
        .action-buttons .btn-outline-warning {
            color: #ed6c02;
            border-color: #ffe082;
            background-color: #fff8e1;
        }
        
        .action-buttons .btn-outline-warning:hover {
            background-color: #ed6c02;
            color: white;
            border-color: #ed6c02;
        }
        
        /* Botão Excluir - Vermelho suave */
        .action-buttons .btn-outline-danger {
            color: #d32f2f;
            border-color: #ffcdd2;
            background-color: #ffebee;
        }
        
        .action-buttons .btn-outline-danger:hover {
            background-color: #d32f2f;
            color: white;
            border-color: #d32f2f;
        }
        
        /* Estilo para o dropdown de sugestões */
        .search-container {
            position: relative;
            width: 100%;
        }
        
        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            display: none;
            margin-top: 2px;
        }
        
        .search-suggestions.show {
            display: block;
        }
        
        .suggestion-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: background-color 0.2s;
        }
        
        .suggestion-item:hover {
            background-color: #f8f9fa;
        }
        
        .suggestion-item .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #f0b354;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .suggestion-item .client-info {
            flex: 1;
            min-width: 0;
        }
        
        .suggestion-item .client-name {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .suggestion-item .client-details {
            font-size: 0.8rem;
            color: #6c757d;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .suggestion-item.highlighted {
            background-color: #f0f0f0;
        }
        
        .badge {
            font-weight: 500;
            padding: 0.4em 0.75em;
        }
        
        .badge-success {
            background-color: #28a74520;
            color: #28a745;
        }
        
        .badge-warning {
            background-color: #ffc10720;
            color: #ffc107;
        }
        
        .badge-danger {
            background-color: #dc354520;
            color: #dc3545;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .page-header {
                flex-direction: column;
                align-items: flex-start !important;
            }
            
            .page-actions {
                margin-top: 1rem;
                width: 100%;
            }
            
            .btn-add-client {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Menu Lateral será carregado dinamicamente via sidebar.js -->
    
    <!-- Botão de toggle para o menu lateral em dispositivos móveis -->
    <button class="btn btn-light d-md-none position-fixed" id="sidebarToggle" style="z-index: 1050; top: 10px; left: 10px;">
        <i class="bi bi-list"></i>
    </button>
    
    <!-- Overlay para fechar o menu ao clicar fora -->
    <div class="sidebar-overlay"></div>
    
    <!-- Conteúdo Principal -->
    <div class="main-content">
        <div class="container-fluid p-0">
            <!-- Cabeçalho da Página -->
            <div class="page-header mb-4">
                <div class="row align-items-center mb-3">
                    <div class="col-12 col-md-6 mb-3 mb-md-0">
                        <div>
                            <h1 class="page-title fw-bolder" style="font-weight: 800 !important; margin-bottom: 10px;">
                                <i class="bi bi-people-fill me-2" style="color: #f0b354;"></i>Clientes
                            </h1>
                            <p class="text-muted mb-0 mt-2">Gerencie os clientes do seu negócio</p>
                        </div>
                    </div>
                    <div class="col-12 col-md-6">
                        <div class="d-flex flex-wrap justify-content-md-end" style="gap: 10px;">
                            <div class="input-group" style="width: 250px;">
                            <span class="input-group-text bg-white border-end-0">
                                <i class="bi bi-search"></i>
                            </span>
                            <input type="text" id="searchInput" class="form-control border-start-0" placeholder="Buscar por nome, CPF ou e-mail...">
                        </div>
                            <button type="button" class="btn btn-primary d-flex align-items-center" id="addClientBtn" style="height: 38px;">
                                <i class="bi bi-plus-lg me-1"></i>
                                <span class="d-none d-sm-inline">Novo Cliente</span>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="border-bottom mt-3"></div>
            </div>
            
            <!-- Card da Tabela de Clientes -->
            <div class="card">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <style>
                            #clientsTable {
                                --bs-table-bg: transparent;
                                --bs-table-striped-bg: #f8f9fa;
                                --bs-table-hover-bg: #f1f3f5;
                                width: 100%;
                                margin-bottom: 1rem;
                                color: #212529;
                                vertical-align: middle;
                                border-color: #e9ecef;
                                table-layout: fixed;
                            }
                            #clientsTable th,
                            #clientsTable td {
                                padding: 0.75rem 1rem;
                                border-bottom: 1px solid #e9ecef;
                                vertical-align: middle;
                                white-space: nowrap;
                                overflow: hidden;
                                text-overflow: ellipsis;
                            }
                            #clientsTable th {
                                background-color: #f8f9fa;
                                font-weight: 600;
                                text-transform: uppercase;
                                font-size: 0.8rem;
                                letter-spacing: 0.5px;
                                color: #495057;
                                position: sticky;
                                top: 0;
                                z-index: 10;
                                border-bottom: 2px solid #e9ecef;
                            }
                            #clientsTable tbody tr:hover {
                                background-color: rgba(0, 0, 0, 0.02);
                            }
                            #clientsTable .action-buttons {
                                display: flex;
                                gap: 0.5rem;
                                justify-content: flex-end;
                                flex-wrap: nowrap;
                            }
                            @media (max-width: 768px) {
                                #clientsTable .action-buttons {
                                    flex-direction: column;
                                    gap: 0.25rem;
                                }
                                #clientsTable .action-buttons .btn {
                                    width: 100%;
                                    margin: 0.1rem 0;
                                }
                            }
                        </style>
                        <table class="table mb-0" id="clientsTable">
                            <thead>
                                <tr>
                                    <th style="width: 10%;">ID</th>
                                    <th style="width: 35%;">Nome</th>
                                    <th style="width: 20%;">Telefone</th>
                                    <th style="width: 15%; text-align: center;">Status</th>
                                    <th style="width: 20%; text-align: center;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="clientsTableBody">
                                <!-- Dados serão carregados via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer bg-white d-flex justify-content-between align-items-center">
                    <div class="text-muted small">
                        Mostrando <span id="showingFrom">0</span> a <span id="showingTo">0</span> de <span id="totalClients">0</span> cliente(s)
                    </div>
                    <nav aria-label="Navegação de páginas">
                        <ul class="pagination pagination-sm mb-0">
                            <!-- A navegação será preenchida dinamicamente pelo JavaScript -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Adicionar/Editar Cliente -->
    <div class="modal fade" id="addClientModal" tabindex="-1" aria-labelledby="addClientModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg" style="max-width: 800px;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addClientModalLabel">Adicionar Novo Cliente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <form id="clientForm">
                    <div class="modal-body">
                        <input type="hidden" id="clientId">
                        <div class="mb-3">
                            <label for="clientName" class="form-label">Nome Completo</label>
                            <input type="text" class="form-control" id="clientName" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="clientEmail" class="form-label">E-mail</label>
                                <input type="email" class="form-control" id="clientEmail">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="clientPhone" class="form-label">Telefone</label>
                                <input type="tel" class="form-control" id="clientPhone" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="clientCpf" class="form-label">CPF</label>
                                <input type="text" class="form-control" id="clientCpf">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="clientBirthDate" class="form-label">Data de Nascimento</label>
                                <input type="date" class="form-control" id="clientBirthDate">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="clientStreet" class="form-label">Rua</label>
                            <input type="text" class="form-control" id="clientStreet">
                        </div>
                        <div class="row">
                            <div class="col-md-2 mb-3">
                                <label for="clientNumber" class="form-label">Número</label>
                                <input type="text" class="form-control" id="clientNumber">
                            </div>
                            <div class="col-md-5 mb-3">
                                <label for="clientNeighborhood" class="form-label">Bairro</label>
                                <input type="text" class="form-control" id="clientNeighborhood">
                            </div>
                            <div class="col-md-5 mb-3">
                                <label for="clientCity" class="form-label">Cidade</label>
                                <input type="text" class="form-control" id="clientCity">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="clientState" class="form-label">UF</label>
                                <select class="form-select" id="clientState" style="min-width: 80px;">
                                    <option value="">Selecione...</option>
                                    <option value="AC">AC</option>
                                    <option value="AL">AL</option>
                                    <option value="AP">AP</option>
                                    <option value="AM">AM</option>
                                    <option value="BA">BA</option>
                                    <option value="CE">CE</option>
                                    <option value="DF">DF</option>
                                    <option value="ES">ES</option>
                                    <option value="GO">GO</option>
                                    <option value="MA">MA</option>
                                    <option value="MT">MT</option>
                                    <option value="MS">MS</option>
                                    <option value="MG">MG</option>
                                    <option value="PA">PA</option>
                                    <option value="PB">PB</option>
                                    <option value="PR">PR</option>
                                    <option value="PE">PE</option>
                                    <option value="PI">PI</option>
                                    <option value="RJ">RJ</option>
                                    <option value="RN">RN</option>
                                    <option value="RS">RS</option>
                                    <option value="RO">RO</option>
                                    <option value="RR">RR</option>
                                    <option value="SC">SC</option>
                                    <option value="SP">SP</option>
                                    <option value="SE">SE</option>
                                    <option value="TO">TO</option>
                                </select>
                            </div>
                            <div class="col-md-5 mb-3">
                                <label for="clientZipCode" class="form-label">CEP</label>
                                <input type="text" class="form-control" id="clientZipCode">
                            </div>
                            <div class="col-md-5 mb-3">
                                <label for="clientComplement" class="form-label">Complemento</label>
                                <input type="text" class="form-control" id="clientComplement">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="clientNotes" class="form-label">Observações</label>
                            <textarea class="form-control" id="clientNotes" rows="3"></textarea>
                        </div>
                        <div class="form-group mb-3">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="clientStatus">
                                <option value="ATIVO">Ativo</option>
                                <option value="INATIVO">Inativo</option>
                                <option value="PENDENTE">Pendente</option>
                                <option value="BLOQUEADO">Bloqueado</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Salvar Cliente</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação de Exclusão -->
    <div class="modal fade" id="deleteClientModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmar Exclusão</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <p>Tem certeza que deseja excluir este cliente? Esta ação não pode ser desfeita.</p>
                    <p class="mb-0"><strong>Cliente:</strong> <span id="clientToDelete"></span></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmDelete">Excluir</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    
    <script>
        // Variáveis globais
        let clients = [];
        let filteredClients = [];
        let currentPage = 1;
        const itemsPerPage = 10; // Exibir 10 clientes por página
        let showInactiveClients = false;
        
        // Inicialização quando o DOM estiver pronto
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar máscaras
            $('#clientPhone').mask('(00) 00000-0000');
            $('#clientZipCode').mask('00000-000');
            
            // Carregar clientes
            loadClients();
            
            // Configurar eventos
            setupEventListeners();
            
            // Inicializar DataTable
            initDataTable();
            
            // Configurar menu mobile
            setupMobileMenu();
            
            // Verificar autenticação
            checkAuth();
        });
        
        // Função para obter o token JWT do localStorage
        function getAuthToken() {
            const token = localStorage.getItem('token');
            console.log('Token recuperado do localStorage:', token ? 'Presente' : 'Ausente');
            if (!token) {
                console.warn('Nenhum token encontrado no localStorage');
        }
        return token;
    }

    // Função para verificar autenticação
    function checkAuth() {
        console.log('Verificando autenticação...');
        const token = getAuthToken();
        
        if (!token) {
            console.warn('Usuário não autenticado, redirecionando para login...');
            window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.pathname);
            return false;
        }
        
        try {
            // Verificar se o token é válido (opcional, pode ser verificado no servidor)
            const payload = JSON.parse(atob(token.split('.')[1]));
            const isExpired = payload.exp * 1000 < Date.now();
            
            if (isExpired) {
                console.warn('Token expirado, redirecionando para login...');
                localStorage.removeItem('token');
                window.location.href = 'login.html?session=expired';
                return false;
            }
            
            console.log('Usuário autenticado com sucesso');
            return true;
        } catch (error) {
            console.error('Erro ao verificar token:', error);
            localStorage.removeItem('token');
            window.location.href = 'login.html?error=invalid_token';
            return false;
        }
    }

        // Função para fazer requisições autenticadas
        async function fetchWithAuth(url, options = {}) {
            const token = getAuthToken();
            console.log('Token recuperado do localStorage:', token ? 'Presente' : 'Ausente');
            
            // Garante que headers exista e seja um objeto
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };

            // Adiciona o token apenas se existir
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            try {
                console.log(`Enviando requisição para: ${url}`);
                console.log('Headers da requisição:', JSON.stringify(headers, null, 2));
                
                const response = await fetch(url, {
                    ...options,
                    headers,
                    credentials: 'include',
                    mode: 'cors' // Adiciona o modo CORS explicitamente
                });
                
                console.log('Resposta recebida:', response.status, response.statusText);

                if (response.status === 401) {
                    // Token expirado ou inválido
                    localStorage.removeItem('token');
                    window.location.href = 'login.html';
                    return null;
                }

                // Handle 204 No Content response
                if (response.status === 204) {
                    return { success: true };
                }

                const contentType = response.headers.get('content-type');
                let responseData = {};
                
                // Only try to parse JSON if content-type is application/json
                if (contentType && contentType.includes('application/json')) {
                    try {
                        responseData = await response.json();
                    } catch (e) {
                        console.warn('Failed to parse JSON response:', e);
                    }
                }

                if (!response.ok) {
                    throw new Error(responseData.message || 'Erro na requisição');
                }

                return responseData;
            } catch (error) {
                console.error('Erro na requisição:', error);
                Swal.fire({
                    title: 'Erro!',
                    text: error.message || 'Ocorreu um erro ao processar sua solicitação',
                    icon: 'error',
                    confirmButtonColor: '#f0b354'
                });
                throw error;
            }
        }

        // Função para carregar clientes da API
       async function loadClients() {
    try {
        console.log('Iniciando carregamento de clientes...');
        // Buscando todos os clientes, não apenas os do usuário logado
        const data = await fetchWithAuth('/api/clientes?limit=1000');
        console.log('Dados recebidos da API:', data);
        
        if (data) {
            // Verifica se a resposta tem uma propriedade 'clientes' (array)
            const clientesArray = data.clientes || data;
            
            if (!Array.isArray(clientesArray)) {
                console.error('Dados recebidos não são um array:', clientesArray);
                throw new Error('Formato de dados inválido recebido da API');
            }
            
            clients = clientesArray.map(client => ({
                id: client.id,
                nome: client.nome || 'Nome não informado',
                email: client.email || 'Não informado',
                telefone: client.telefone || 'Não informado',
                rua: client.rua || '',
                numero: client.numero || '',
                complemento: client.complemento || '',
                bairro: client.bairro || '',
                cidade: client.cidade || '',
                estado: client.estado || '',
                cep: client.cep || '',
                cpf: client.cpf || '',
                dataNascimento: client.dataNascimento || null,
                observacoes: client.observacoes || '',
                status: client.status || 'ATIVO',
                createdAt: client.criadoEm || client.createdAt || new Date().toISOString()
            }));
            
            console.log(`Total de clientes carregados: ${clients.length}`);
            
            renderClientsTable();
            updatePagination();
        } else {
            console.error('Resposta da API vazia');
            showError('Erro', 'Não foi possível carregar a lista de clientes.');
        }
    } catch (error) {
        console.error('Erro ao carregar clientes:', error);
        showError('Erro', `Falha ao carregar clientes: ${error.message}`);
    }
}
        
        // Função para renderizar a tabela de clientes
        function renderClientsTable() {
            const tbody = document.getElementById('clientsTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            try {
                // Verificar se existem clientes para exibir
                if (!clients || clients.length === 0) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td colspan="5" class="text-center py-3">
                            Nenhum cliente encontrado.
                        </td>
                    `;
                    tbody.appendChild(tr);
                    return;
                }

                // Mostrar todos os clientes sem filtrar por status
                filteredClients = [...clients]; // Cria uma cópia do array de clientes
                const totalFilteredClients = filteredClients.length;
                console.log(`Total de clientes encontrados: ${totalFilteredClients}`);
                
                // Calcular índices para a paginação
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                const paginatedClients = filteredClients.slice(startIndex, endIndex);
                
                // Atualizar contadores na interface
                updatePagination();
                
                // Exibir apenas os clientes da página atual
                paginatedClients.forEach(client => {
                    const tr = document.createElement('tr');
                    
                    // Formatar dados para exibição
                    const nome = client.nome || 'Não informado';
                    const email = client.email || 'N/A';
                    const telefone = client.telefone || 'N/A';
                    const status = client.status || 'ATIVO';
                    
                    // Criar a linha da tabela
                    tr.innerHTML = `
                        <td>#${String(client.id).padStart(4, '0')}</td>
                        <td>
                            <div>
                                <h6 class="mb-0">${nome}</h6>
                                <small class="text-muted d-block text-truncate" style="max-width: 250px;" title="${email}">${email}</small>
                            </div>
                        </td>
                        <td>${formatarTelefone(telefone)}</td>
                        <td style="text-align: center;">
                            <span class="badge ${status === 'ATIVO' || status === 'ACTIVE' ? 'bg-success' : 'bg-secondary'}">
                                ${status === 'ATIVO' || status === 'ACTIVE' ? 'Ativo' : 'Inativo'}
                            </span>
                        </td>
                        <td style="text-align: center;">
                            <div class="action-buttons justify-content-center">
                                <button class="btn btn-sm btn-outline-primary view-client" data-id="${client.id}" title="Visualizar">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-warning edit-client" data-id="${client.id}" title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-client" data-id="${client.id}" data-name="${(nome).replace(/"/g, '&quot;')}" title="Excluir">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    tbody.appendChild(tr);
                });
                
                // Adicionar eventos aos botões
                addClientButtonEvents();
                
            } catch (error) {
                console.error('Erro ao renderizar a tabela de clientes:', error);
                
                // Mostrar mensagem de erro na interface
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td colspan="5" class="text-center text-danger py-3">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        Ocorreu um erro ao carregar os clientes. Por favor, tente novamente.
                    </td>
                `;
                tbody.appendChild(tr);
            }
        }
        
        // Função auxiliar para formatar telefone
        function formatarTelefone(telefone) {
            if (!telefone) return 'N/A';
            // Remove tudo que não for dígito
            const numeros = telefone.replace(/\D/g, '');
            
            // Formatação para celular (11 dígitos) com DDD
            if (numeros.length === 11) {
                return `(${numeros.substring(0, 2)}) ${numeros.substring(2, 7)}-${numeros.substring(7)}`;
            }
            // Formatação para telefone fixo (10 dígitos) com DDD
            if (numeros.length === 10) {
                return `(${numeros.substring(0, 2)}) ${numeros.substring(2, 6)}-${numeros.substring(6)}`;
            }
            // Retorna o número sem formatação se não atender aos padrões
            return telefone;
        }
        
        // Função para formatar CPF (usada em outros lugares do código)
        function formatCPF(cpf) {
            if (!cpf) return 'N/A';
            // Remove tudo que não for dígito
            const numeros = cpf.replace(/\D/g, '');
            // Aplica a formatação do CPF: 000.000.000-00
            return numeros.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
        }
        
        // Função para obter a classe do badge de status (usada em outros lugares do código)
        function getStatusBadgeClass(status) {
            if (!status) return 'bg-secondary';
            switch(status.toUpperCase()) {
                case 'ATIVO':
                case 'ACTIVE':
                    return 'bg-success';
                case 'INATIVO':
                case 'INACTIVE':
                    return 'bg-secondary';
                case 'PENDENTE':
                case 'PENDING':
                    return 'bg-warning';
                case 'BLOQUEADO':
                case 'BLOCKED':
                    return 'bg-danger';
                default:
                    return 'bg-secondary';
            }
        }
        
        // Função para obter o texto do status (usada em outros lugares do código)
        function getStatusText(status) {
            if (!status) return 'Desconhecido';
            
            const statusMap = {
                'ATIVO': 'Ativo',
                'ACTIVE': 'Ativo',
                'INATIVO': 'Inativo',
                'INACTIVE': 'Inativo',
                'PENDENTE': 'Pendente',
                'PENDING': 'Pendente',
                'BLOQUEADO': 'Bloqueado',
                'BLOCKED': 'Bloqueado'
            };
            
            return statusMap[status.toUpperCase()] || 'Desconhecido';
        }
        
        // Função para configurar eventos dos botões da tabela
        function addClientButtonEvents() {
            // Visualizar cliente
            document.querySelectorAll('.view-client').forEach(btn => {
                btn.addEventListener('click', function() {
                    const clientId = parseInt(this.getAttribute('data-id'));
                    viewClient(clientId);
                });
            });
            
            // Editar cliente
            document.querySelectorAll('.edit-client').forEach(btn => {
                btn.addEventListener('click', function() {
                    const clientId = parseInt(this.getAttribute('data-id'));
                    editClient(clientId);
                });
            });
            
            // Excluir cliente
            document.querySelectorAll('.delete-client').forEach(btn => {
                btn.addEventListener('click', function() {
                    const clientId = parseInt(this.getAttribute('data-id'));
                    const clientName = this.getAttribute('data-name');
                    showDeleteConfirmation(clientId, clientName);
                });
            });
        }
        
        // Função para visualizar cliente
        async function viewClient(clientId) {
            try {
                console.log(`Carregando detalhes do cliente ID: ${clientId}`);
                const response = await fetchWithAuth(`/api/clientes/${clientId}`);
                
                // Verifica se a resposta tem dados válidos
                if (response && (response.data || response.id)) {
                    // O cliente pode estar em response.data ou diretamente no response
                    const client = response.data || response;
                    console.log('Dados do cliente recebidos para visualização:', client);
                    
                    // Função auxiliar para formatar dados
                    const formatValue = (value, defaultValue = 'N/A') => {
                        return value || value === 0 ? value : defaultValue;
                    };
                    
                    // Formatar endereço completo
                    const enderecoCompleto = [
                        client.rua,
                        client.numero,
                        client.complemento,
                        client.bairro
                    ].filter(Boolean).join(', ');
                    
                    // Formatar cidade/UF
                    const cidadeUf = [
                        client.cidade,
                        client.estado ? `/${client.estado}` : ''
                    ].filter(Boolean).join(' ');
                    
                    // Formatar CEP
                    const cepFormatado = client.cep ? 
                        client.cep.replace(/(\d{5})(\d{3})/, '$1-$2') : 'N/A';
                    
                    // Formatar CPF
                    const cpfFormatado = client.cpf ? 
                        client.cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4') : 'N/A';
                    
                    // Formatar data de nascimento
                    const formatarData = (dataString) => {
                        if (!dataString) return 'N/A';
                        try {
                            const data = new Date(dataString);
                            return data.toLocaleDateString('pt-BR');
                        } catch (e) {
                            console.warn('Erro ao formatar data:', e);
                            return dataString; // Retorna o valor original se não conseguir formatar
                        }
                    };
                    
                    // Criar o HTML do modal
                    const htmlContent = `
                        <div class="text-start">
                            <div class="mb-3">
                                <h5 class="mb-3">Informações Pessoais</h5>
                                <p><strong>Nome:</strong> ${formatValue(client.nome)}</p>
                                <p><strong>E-mail:</strong> ${formatValue(client.email)}</p>
                                <p><strong>Telefone:</strong> ${formatValue(client.telefone)}</p>
                                <p><strong>CPF:</strong> ${cpfFormatado}</p>
                                <p><strong>Data de Nascimento:</strong> ${formatarData(client.dataNascimento)}</p>
                            </div>
                            
                            <div class="mb-3">
                                <h5 class="mb-3">Endereço</h5>
                                <p><strong>Logradouro:</strong> ${formatValue(enderecoCompleto)}</p>
                                <p><strong>Cidade/UF:</strong> ${formatValue(cidadeUf)}</p>
                                <p><strong>CEP:</strong> ${cepFormatado}</p>
                            </div>
                            
                            <div class="mb-3">
                                <h5 class="mb-3">Outras Informações</h5>
                                <p>
                                    <strong>Status:</strong> 
                                    <span class="badge ${getStatusBadgeClass(client.status)}">
                                        ${getStatusText(client.status) || 'N/A'}
                                    </span>
                                </p>
                                <p><strong>Data de Cadastro:</strong> ${formatarData(client.criadoEm || client.createdAt)}</p>
                                ${client.observacoes ? `
                                    <div class="mt-2">
                                        <strong>Observações:</strong>
                                        <div class="p-2 bg-light rounded">
                                            ${client.observacoes}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                    
                    // Exibir o modal
                    Swal.fire({
                        title: client.nome || 'Detalhes do Cliente',
                        html: htmlContent,
                        confirmButtonText: 'Fechar',
                        confirmButtonColor: '#f0b354',
                        showCloseButton: true,
                        width: '650px',
                        customClass: {
                            popup: 'text-start'
                        }
                    });
                } else {
                    throw new Error('Dados do cliente não encontrados na resposta');
                }
            } catch (error) {
                console.error('Erro ao carregar detalhes do cliente:', error);
                Swal.fire({
                    title: 'Erro!',
                    text: error.message || 'Não foi possível carregar os dados do cliente',
                    icon: 'error',
                    confirmButtonColor: '#f0b354'
                });
            }
        }
        
        // Função para carregar os detalhes de um cliente
        async function loadClientDetails(clientId) {
            try {
                console.log(`Carregando detalhes do cliente ID: ${clientId}`);
                const response = await fetchWithAuth(`/api/clientes/${clientId}`);
                
                if (response && (response.data || response.id)) {
                    // O cliente pode estar em response.data ou diretamente no response
                    const client = response.data || response;
                    console.log('Dados do cliente recebidos:', client);
                    
                    // Função para formatar data para o input type="date"
                    const formatDateForInput = (dateString) => {
                        if (!dateString) return '';
                        try {
                            const date = new Date(dateString);
                            return date.toISOString().split('T')[0];
                        } catch (e) {
                            console.warn('Erro ao formatar data:', e);
                            return '';
                        }
                    };
                    
                    // Preencher os campos do formulário
                    const setValue = (id, value) => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.value = value || '';
                        } else {
                            console.warn(`Elemento não encontrado: ${id}`);
                        }
                    };
                    
                    // Mapeamento dos campos
                    const fields = {
                        'clientId': client.id,
                        'clientName': client.nome,
                        'clientEmail': client.email,
                        'clientPhone': client.telefone,
                        'clientBirthDate': formatDateForInput(client.dataNascimento),
                        'clientStreet': client.rua,
                        'clientNumber': client.numero,
                        'clientComplement': client.complemento,
                        'clientNeighborhood': client.bairro,
                        'clientCity': client.cidade,
                        'clientState': client.estado,
                        'clientZipCode': client.cep ? client.cep.replace(/(\d{5})(\d{3})/, '$1-$2') : '',
                        'clientNotes': client.observacoes,
                        'clientStatus': client.status || 'ATIVO'
                    };
                    
                    // CPF com formatação especial
                    const cpfFormatado = client.cpf ? 
                        client.cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4') : 
                        '';
                    setValue('clientCpf', cpfFormatado);
                    
                    // Preencher todos os campos
                    Object.entries(fields).forEach(([id, value]) => {
                        setValue(id, value);
                    });
                    
                    // Atualizar o título do modal
                    const modalTitle = document.getElementById('addClientModalLabel');
                    if (modalTitle) {
                        modalTitle.textContent = 'Editar Cliente';
                    }
                    
                    // Abrir o modal
                    const modalElement = document.getElementById('addClientModal');
                    if (modalElement) {
                        const modal = new bootstrap.Modal(modalElement);
                        modal.show();
                    } else {
                        console.error('Modal não encontrado');
                    }
                } else {
                    throw new Error('Dados do cliente não encontrados na resposta');
                }
            } catch (error) {
                console.error('Erro ao carregar detalhes do cliente:', error);
                Swal.fire({
                    title: 'Erro!',
                    text: error.message || 'Não foi possível carregar os dados do cliente',
                    icon: 'error',
                    confirmButtonColor: '#f0b354'
                });
            }
        }
        
        // Função para editar cliente
        function editClient(clientId) {
            loadClientDetails(clientId);
        }
        
        // Função para mostrar confirmação de exclusão
        function showDeleteConfirmation(clientId, clientName) {
            document.getElementById('clientToDelete').textContent = clientName;
            
            const modal = new bootstrap.Modal(document.getElementById('deleteClientModal'));
            modal.show();
            
            document.getElementById('confirmDelete').onclick = function() {
                deleteClient(clientId);
                modal.hide();
            };
        }
        
        // Função para excluir cliente
        async function deleteClient(clientId) {
            try {
                console.log(`Excluindo cliente com ID: ${clientId}`);
                
                const response = await fetchWithAuth(`/api/clientes/${clientId}`, {
                    method: 'DELETE'
                });
                
                // Se chegou aqui, a requisição foi bem-sucedida (incluindo 204 No Content)
                console.log('Cliente excluído com sucesso:', response);
                
                // Remover o cliente da lista local
                clients = clients.filter(client => client.id !== parseInt(clientId));
                
                // Atualizar a tabela e a paginação
                renderClientsTable();
                updatePagination();
                
                // Mostrar mensagem de sucesso
                showSuccess('Cliente excluído com sucesso!');
                
            } catch (error) {
                console.error('Erro ao excluir cliente:', error);
                Swal.fire({
                    title: 'Erro!',
                    text: error.message || 'Ocorreu um erro ao excluir o cliente',
                    icon: 'error',
                    confirmButtonColor: '#f0b354'
                });
            }
        }
        
        // Função para atualizar a exibição dos clientes com paginação
        function updatePagination() {
            const totalClients = filteredClients ? filteredClients.length : 0;
            const totalPages = Math.ceil(totalClients / itemsPerPage);
            const paginationContainer = document.querySelector('.pagination');
            
            // Atualizar o texto de exibição com a contagem de clientes
            const showingFromEl = document.getElementById('showingFrom');
            const showingToEl = document.getElementById('showingTo');
            const totalClientsEl = document.getElementById('totalClients');
            
            if (showingFromEl && showingToEl && totalClientsEl) {
                const start = totalClients > 0 ? ((currentPage - 1) * itemsPerPage) + 1 : 0;
                const end = Math.min(currentPage * itemsPerPage, totalClients);
                
                showingFromEl.textContent = start;
                showingToEl.textContent = end;
                totalClientsEl.textContent = totalClients;
            }
            
            // Atualizar controles de paginação
            if (paginationContainer) {
                let paginationHTML = '';
                
                // Botão Anterior
                paginationHTML += `
                    <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                        <a class="page-link" href="#" id="prevPage">Anterior</a>
                    </li>
                `;
                
                // Números das páginas
                let startPage = Math.max(1, currentPage - 2);
                let endPage = Math.min(totalPages, startPage + 4);
                
                if (endPage - startPage < 4 && totalPages > 4) {
                    startPage = Math.max(1, endPage - 4);
                }
                
                for (let i = startPage; i <= endPage; i++) {
                    paginationHTML += `
                        <li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link page-number" href="#" data-page="${i}">${i}</a>
                        </li>
                    `;
                }
                
                // Botão Próximo
                paginationHTML += `
                    <li class="page-item ${currentPage >= totalPages ? 'disabled' : ''}">
                        <a class="page-link" href="#" id="nextPage">Próximo</a>
                    </li>
                `;
                
                paginationContainer.innerHTML = paginationHTML;
                paginationContainer.style.display = totalPages > 1 ? 'flex' : 'none';
                
                // Adicionar eventos aos botões de paginação
                document.getElementById('prevPage')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (currentPage > 1) {
                        currentPage--;
                        renderClientsTable();
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                });
                
                document.getElementById('nextPage')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (currentPage < totalPages) {
                        currentPage++;
                        renderClientsTable();
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                });
                
                document.querySelectorAll('.page-number').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const page = parseInt(e.target.getAttribute('data-page'));
                        if (page !== currentPage) {
                            currentPage = page;
                            renderClientsTable();
                            window.scrollTo({ top: 0, behavior: 'smooth' });
                        }
                    });
                });
            }
        }
        
        // Função para obter a classe CSS do badge de status
        function getStatusBadgeClass(status) {
            const statusClasses = {
                'ACTIVE': 'bg-success',
                'INACTIVE': 'bg-secondary',
                'PENDING': 'bg-warning text-dark',
                'BLOCKED': 'bg-danger'
            };
            return statusClasses[status] || 'bg-secondary';
        }

        // Função para obter o texto do status
        function getStatusText(status) {
            const statusTexts = {
                'ACTIVE': 'Ativo',
                'INACTIVE': 'Inativo',
                'PENDING': 'Pendente',
                'BLOCKED': 'Bloqueado'
            };
            return statusTexts[status] || status;
        }

        // Função para formatar data
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            
            const options = { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return 'Data inválida';
                
                // Verificar se a data tem hora definida
                const hasTime = dateString.includes('T') || dateString.includes(' ');
                
                if (hasTime) {
                    return date.toLocaleString('pt-BR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } else {
                    return date.toLocaleDateString('pt-BR');
                }
            } catch (e) {
                console.error('Erro ao formatar data:', e);
                return dateString;
            }
        }
        
        // Função para configurar os listeners de eventos
        function setupEventListeners() {
            // Formulário de cliente
            const clientForm = document.getElementById('clientForm');
            if (clientForm) {
                clientForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveClient();
                });
            }
            
            // Botão de novo cliente (barra lateral)
            const newClientBtn = document.querySelector('.btn-add-client');
            if (newClientBtn) {
                newClientBtn.addEventListener('click', function() {
                    resetClientForm();
                    document.getElementById('addClientModalLabel').textContent = 'Adicionar Novo Cliente';
                });
            }
            
            // Botão de novo cliente (ao lado da busca)
            const addClientBtn = document.getElementById('addClientBtn');
            if (addClientBtn) {
                addClientBtn.addEventListener('click', function() {
                    resetClientForm();
                    const modal = new bootstrap.Modal(document.getElementById('addClientModal'));
                    modal.show();
                });
            }
            
            // Busca na tabela
            const searchInput = document.getElementById('searchInput');
            let debounceTimer;
            
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value.trim();
                    clearTimeout(debounceTimer);
                    
                    debounceTimer = setTimeout(() => {
                        if (searchTerm.length > 1 || searchTerm.length === 0) {
                            filterClients(searchTerm);
                        }
                    }, 300);
                });
                
                // Pesquisar ao pressionar Enter
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const searchTerm = this.value.trim();
                        if (searchTerm.length > 0) {
                            filterClients(searchTerm);
                        }
                    }
                });
            }
        }
        

        // Função para filtrar clientes na tabela
        function filterClients(searchTerm) {
            currentPage = 1; // Reset para a primeira página ao filtrar
            const tbody = document.getElementById('clientsTableBody');
            tbody.innerHTML = '';
            
            // Se não houver termo de busca, exibe todos os clientes ativos
            if (!searchTerm || searchTerm.trim() === '') {
                renderClientsTable();
                return;
            }
            
            // Filtra os clientes com base no termo de busca
            const filteredClients = clients.filter(client => {
                const searchLower = searchTerm.toLowerCase();
                return (
                    (client.nome && client.nome.toLowerCase().includes(searchLower)) ||
                    (client.email && client.email.toLowerCase().includes(searchLower)) ||
                    (client.cpf && client.cpf.includes(searchTerm)) ||
                    (client.telefone && client.telefone.includes(searchTerm))
                );
            });
            
            // Se não encontrar resultados
            if (filteredClients.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td colspan="5" class="text-center py-4">
                        <div class="text-muted">
                            <i class="bi bi-search display-5 d-block mb-2"></i>
                            Nenhum cliente encontrado para "${searchTerm}"
                        </div>
                    </td>`;
                tbody.appendChild(tr);
                
                // Atualizar informações de paginação
                document.getElementById('showingFrom').textContent = 0;
                document.getElementById('showingTo').textContent = 0;
                document.getElementById('totalClients').textContent = 0;
                
                return;
            }
            
            // Exibe os resultados da busca
            filteredClients.forEach(client => {
                const tr = document.createElement('tr');
                const nome = client.nome || 'Não informado';
                const email = client.email || 'N/A';
                
                tr.innerHTML = `
                    <td>#${String(client.id).padStart(4, '0')}</td>
                    <td>
                        <div>
                            <h6 class="mb-0">${nome}</h6>
                            <small class="text-muted d-block text-truncate" style="max-width: 250px;" title="${email}">${email}</small>
                        </div>
                    </td>
                    <td>${client.telefone || 'N/A'}</td>
                    <td style="text-align: center;">
                        <span class="badge ${getStatusBadgeClass(client.status)}">
                            ${getStatusText(client.status)}
                        </span>
                    </td>
                    <td style="text-align: center;">
                        <div class="action-buttons justify-content-center">
                            <button class="btn btn-sm btn-outline-primary view-client" data-id="${client.id}" title="Visualizar">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-warning edit-client" data-id="${client.id}" title="Editar">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger delete-client" data-id="${client.id}" data-name="${(client.nome || '').replace(/"/g, '&quot;')}" title="Excluir">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>`;
                tbody.appendChild(tr);
            });
            
            // Atualizar informações de paginação
            document.getElementById('showingFrom').textContent = 1;
            document.getElementById('showingTo').textContent = filteredClients.length;
            document.getElementById('totalClients').textContent = filteredClients.length;
            
            // Adicionar eventos aos botões
            addClientButtonEvents();
        }
        
        // Função para salvar cliente (adicionar ou atualizar)
        async function saveClient() {
            const id = document.getElementById('clientId').value;
            const nome = document.getElementById('clientName').value.trim();
            const email = document.getElementById('clientEmail').value.trim();
            const telefone = document.getElementById('clientPhone').value.trim();
            const cpfInput = document.getElementById('clientCpf');
            const cpf = cpfInput.value.trim();
            console.log('Valor bruto do CPF:', cpf);
            const cpfApenasNumeros = cpf.replace(/\D/g, '');
            console.log('CPF apenas números:', cpfApenasNumeros);
            const dataNascimento = document.getElementById('clientBirthDate').value;
            const rua = document.getElementById('clientStreet').value.trim();
            const numero = document.getElementById('clientNumber').value.trim();
            const complemento = document.getElementById('clientComplement').value.trim();
            const bairro = document.getElementById('clientNeighborhood').value.trim();
            const cidade = document.getElementById('clientCity').value.trim();
            const estado = document.getElementById('clientState').value;
            const cep = document.getElementById('clientZipCode').value.trim();
            const observacoes = document.getElementById('clientNotes').value.trim();
            const status = document.getElementById('clientStatus').value;
            
            // Validação básica
            if (!nome) {
                showError('Erro de Validação', 'O nome do cliente é obrigatório.');
                return;
            }
            
            try {
                const clientData = {
                    nome,
                    email: email || null,
                    telefone: telefone || null,
                    cpf: cpfApenasNumeros || null,
                    dataNascimento: dataNascimento || null,
                    rua: rua || null,
                    numero: numero || null,
                    complemento: complemento || null,
                    bairro: bairro || null,
                    cidade: cidade || null,
                    estado: estado || null,
                    cep: cep || null,
                    observacoes: observacoes || null,
                    status: status || 'ATIVO'
                };
                
                // Log detalhado dos dados do cliente
                console.log('Dados do cliente a serem enviados:', JSON.stringify(clientData, null, 2));
                console.log('CPF antes de enviar:', clientData.cpf);
                
                let response;
                
                if (id) {
                    // Atualizar cliente existente
                    response = await fetchWithAuth(`/api/clientes/${id}`, {
                        method: 'PUT',
                        body: JSON.stringify(clientData)
                    });
                    
                    if (response) {
                        console.log('Resposta da API (atualização):', response);
                        console.log('CPF salvo na resposta:', response.cpf);
                        showSuccess('Cliente atualizado com sucesso!');
                    } else {
                        console.error('Erro ao atualizar cliente:', response);
                    }
                } else {
                    // Criar novo cliente
                    response = await fetchWithAuth('/api/clientes', {
                        method: 'POST',
                        body: JSON.stringify(clientData)
                    });
                    
                    if (response) {
                        console.log('Resposta da API (criação):', response);
                        console.log('CPF salvo na resposta:', response.cpf);
                        showSuccess('Cliente adicionado com sucesso!');
                        currentPage = 1; // Voltar para a primeira página
                    } else {
                        console.error('Erro ao criar cliente:', response);
                    }
                }
                
                // Fechar o modal e recarregar os clientes
                const modal = bootstrap.Modal.getInstance(document.getElementById('addClientModal'));
                if (modal) modal.hide();
                
                // Recarregar a lista de clientes
                await loadClients();
                
            } catch (error) {
                console.error('Erro ao salvar cliente:', error);
                Swal.fire({
                    title: 'Erro!',
                    text: error.message || 'Ocorreu um erro ao salvar o cliente',
                    icon: 'error',
                    confirmButtonColor: '#f0b354'
                });
            }
        }
        
        // Função para resetar o formulário de cliente
        function resetClientForm() {
            document.getElementById('clientForm').reset();
            document.getElementById('clientId').value = '';
            document.getElementById('clientStatus').value = 'ATIVO';
        }
        
        // Função para mostrar mensagem de sucesso
        function showSuccess(message) {
            Swal.fire({
                title: 'Sucesso!',
                text: message,
                icon: 'success',
                confirmButtonColor: '#f0b354',
                timer: 2000,
                timerProgressBar: true
            });
        }
        
        // Função para mostrar mensagem de erro
        function showError(title, message) {
            Swal.fire({
                title: title,
                text: message,
                icon: 'error',
                confirmButtonColor: '#f0b354'
            });
        }
        
        // Função para configurar a tabela
        function initDataTable() {
            // Configuração da busca
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    filterClients(searchTerm);
                });
            }
        }
        
        // Função para configurar o menu mobile
        function setupMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebarOverlay = document.querySelector('.sidebar-overlay');
            
            // Verifica se os elementos existem antes de manipulá-los
            if (!sidebar || !sidebarToggle || !sidebarOverlay) {
                console.warn('Elementos do menu lateral não encontrados');
                return;
            }
            
            sidebarToggle.classList.remove('d-none');
            
            // Adiciona evento de clique no botão de toggle
            sidebarToggle.addEventListener('click', function() {
                if (sidebar && sidebarOverlay) {
                    sidebar.classList.toggle('active');
                    sidebarOverlay.style.display = sidebar.classList.contains('active') ? 'block' : 'none';
                    document.body.style.overflow = sidebar.classList.contains('active') ? 'hidden' : '';
                }
            });
            
            // Fecha o menu ao clicar no overlay
            sidebarOverlay.addEventListener('click', function() {
                if (sidebar) {
                    sidebar.classList.remove('active');
                }
                this.style.display = 'none';
                document.body.style.overflow = '';
            });
            
            // Fechar o menu ao clicar em um link
            const navLinks = document.querySelectorAll('.sidebar .nav-link');
            if (navLinks.length > 0) {
                navLinks.forEach(link => {
                    link.addEventListener('click', function() {
                        if (window.innerWidth < 992 && sidebar && sidebarOverlay) {
                            sidebar.classList.remove('active');
                            sidebarOverlay.style.display = 'none';
                            document.body.style.overflow = '';
                        }
                    });
                });
            }
            
            // Ajustar o menu ao redimensionar a tela
            window.addEventListener('resize', function() {
                if (window.innerWidth >= 992 && sidebar && sidebarOverlay) {
                    sidebar.classList.remove('active');
                    sidebarOverlay.style.display = 'none';
                    document.body.style.overflow = '';
                }
            });
        }
        
        // Adicionar evento de logout
        document.getElementById('logoutBtn')?.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Logout solicitado, removendo token...');
            localStorage.removeItem('token');
            window.location.href = 'login.html?logout=true';
        });
        
        // Inicialização da página
        document.addEventListener('DOMContentLoaded', async function() {
            // Carregar o menu lateral
            if (typeof loadSidebar === 'function') {
                loadSidebar();
            } else {
                console.error('Função loadSidebar não encontrada');
            }
            console.log('Página carregada, verificando autenticação...');
            
            // Verificar autenticação
            const isAuthenticated = await checkAuth();
            if (!isAuthenticated) {
                window.location.href = 'login.html';
                return;
            }
            
            console.log('Usuário autenticado, carregando clientes...');
            
            // Configurar eventos
            setupEventListeners();
            
            // Carregar clientes iniciais
            await loadClients();
            
            console.log('Página inicializada com sucesso!');
        });
    </script>
    <script src="js/sidebar.js"></script>
</body>
</html>