<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profissionais - Sistema de Gestão Clínica</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="css/sidebar.css" rel="stylesheet">
    <link href="css/theme.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #f0b354;    /* Dourado */
            --primary-hover: #d9a24a;   /* Dourado mais escuro */
            --secondary-color: #041a31; /* Azul Royal */
            --secondary-hover: #031425; /* Azul Royal mais escuro */
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --border-color: rgba(240, 179, 84, 0.2);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover, .btn-primary:focus {
            background-color: var(--primary-hover);
            border-color: var(--primary-hover);
        }
        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .table-hover > tbody > tr:hover {
            background-color: #f5f7fa !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
        }
        
        .page-title {
            color: var(--secondary-color);
            font-weight: 600;
        }
        
        .table > :not(:last-child) > :last-child > * {
            border-bottom-color: #e0e0e0;
            border-bottom-width: 2px;
        }
        
        .table-striped > tbody > tr:nth-of-type(odd) {
            background-color: #f9fafb;
        }
        
        .table-striped > tbody > tr:nth-of-type(even) {
            background-color: #ffffff;
        }
        
        .table > thead th {
            border-top: none;
            border-bottom: 2px solid #ced4da !important;
            padding: 1.1rem 1.5rem;
            font-weight: 700 !important;
            color: #000000 !important;
            background-color: #e9ecef !important;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background-color: #f8f9fa;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
        }
        
        .table > tbody > tr {
            border-bottom: 1px solid #e8e9ea;
            transition: background-color 0.15s ease;
        }
        
        .table > tbody > tr:hover {
            background-color: #f8f9fa;
        }
        
        .table td {
            padding: 1.1rem 1.5rem;
            vertical-align: middle;
            border-top: 1px solid #f0f0f0;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
            justify-content: center;
        }
        
        .action-buttons .btn {
            width: 32px;
            height: 32px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            border-radius: 4px;
            transition: all 0.2s ease;
            margin: 0 2px;
            border-width: 1px;
        }
        
        /* Botão Visualizar - Verde suave */
        .action-buttons .btn-outline-primary {
            color: #2e7d32;
            border-color: #a5d6a7;
            background-color: #e8f5e9;
        }
        
        .action-buttons .btn-outline-primary:hover {
            background-color: #2e7d32;
            color: white;
            border-color: #2e7d32;
        }
        
        /* Botão Editar - Amarelo suave */
        .action-buttons .btn-outline-warning {
            color: #ed6c02;
            border-color: #ffe082;
            background-color: #fff8e1;
        }
        
        .action-buttons .btn-outline-warning:hover {
            background-color: #ed6c02;
            color: white;
            border-color: #ed6c02;
        }
        
        /* Botão Excluir - Vermelho suave */
        .action-buttons .btn-outline-danger {
            color: #d32f2f;
            border-color: #ffcdd2;
            background-color: #ffebee;
        }
        
        .action-buttons .btn-outline-danger:hover {
            background-color: #d32f2f;
            color: white;
            border-color: #d32f2f;
        }
        
        /* Estilo para o dropdown de sugestões */
        .search-container {
            position: relative;
            width: 100%;
        }
        
        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            display: none;
            margin-top: 2px;
        }
        
        .search-suggestions.show {
            display: block;
        }
        
        .suggestion-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: background-color 0.2s;
        }
        
        .suggestion-item:hover {
            background-color: #f8f9fa;
        }
        
        .suggestion-item .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #f0b354;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .suggestion-item .profissional-info {
            flex: 1;
            min-width: 0;
        }
        
        .suggestion-item .profissional-name {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .suggestion-item .profissional-details {
            font-size: 0.8rem;
            color: #6c757d;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .suggestion-item.highlighted {
            background-color: #f0f0f0;
        }
        
        .badge {
            font-weight: 500;
            padding: 0.4em 0.75em;
        }
        
        .badge-success {
            background-color: #28a74520;
            color: #28a745;
        }
        
        .badge-warning {
            background-color: #ffc10720;
            color: #ffc107;
        }
        
        .badge-danger {
            background-color: #dc354520;
            color: #dc3545;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .page-header {
                flex-direction: column;
                align-items: flex-start !important;
            }
            
            .page-actions {
                margin-top: 1rem;
                width: 100%;
            }
            
            .btn-add-profissional {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Menu Lateral será carregado dinamicamente via sidebar.js -->
    
    <!-- Botão de toggle para o menu lateral em dispositivos móveis -->
    <button class="btn btn-light d-md-none position-fixed" id="sidebarToggle" style="z-index: 1050; top: 10px; left: 10px;">
        <i class="bi bi-list"></i>
    </button>
    
    <!-- Overlay para fechar o menu ao clicar fora -->
    <div class="sidebar-overlay"></div>
    
    <!-- Conteúdo Principal -->
    <div class="main-content">
        <div class="container-fluid p-0">
            <!-- Cabeçalho da Página -->
            <div class="page-header mb-4">
                <div class="row align-items-center mb-3">
                    <div class="col-12 col-md-6 mb-3 mb-md-0">
                        <div>
                            <h1 class="page-title fw-bolder" style="font-weight: 800 !important; margin-bottom: 10px;">
                                <i class="bi bi-people-fill me-2" style="color: #f0b354;"></i>Profissionais
                            </h1>
                            <p class="text-muted mb-0 mt-2">Gerencie os profissionais do seu negócio</p>
                        </div>
                    </div>
                    <div class="col-12 col-md-6">
                        <div class="d-flex flex-wrap justify-content-md-end" style="gap: 10px;">
                            <div class="input-group" style="width: 250px;">
                            <span class="input-group-text bg-white border-end-0">
                                <i class="bi bi-search"></i>
                            </span>
                            <input type="text" id="searchInput" class="form-control border-start-0" placeholder="Buscar por nome, CPF ou e-mail...">
                        </div>
                            <button type="button" class="btn btn-primary d-flex align-items-center" id="addProfissionalBtn" style="height: 38px;">
                                <i class="bi bi-plus-lg me-1"></i>
                                <span class="d-none d-sm-inline">Novo Profissional</span>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="border-bottom mt-3"></div>
            </div>
            
            <!-- Card da Tabela de Profissionais -->
            <div class="card">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <style>
                            #profissionaisTable {
                                --bs-table-bg: transparent;
                                --bs-table-striped-bg: #f8f9fa;
                                --bs-table-hover-bg: #f1f3f5;
                                width: 100%;
                                margin-bottom: 1rem;
                                color: #212529;
                                vertical-align: middle;
                                border-color: #e9ecef;
                                table-layout: fixed;
                            }
                            #profissionaisTable th,
                            #profissionaisTable td {
                                padding: 0.75rem 1rem;
                                border-bottom: 1px solid #e9ecef;
                                vertical-align: middle;
                                white-space: nowrap;
                                overflow: hidden;
                                text-overflow: ellipsis;
                            }
                            #profissionaisTable th {
                                background-color: #f8f9fa;
                                font-weight: 600;
                                text-transform: uppercase;
                                font-size: 0.8rem;
                                letter-spacing: 0.5px;
                                color: #495057;
                                position: sticky;
                                top: 0;
                                z-index: 10;
                                border-bottom: 2px solid #e9ecef;
                            }
                            #profissionaisTable tbody tr:hover {
                                background-color: rgba(0, 0, 0, 0.02);
                            }
                            #profissionaisTable .action-buttons {
                                display: flex;
                                gap: 0.5rem;
                                justify-content: flex-end;
                                flex-wrap: nowrap;
                            }
                            @media (max-width: 768px) {
                                #profissionaisTable .action-buttons {
                                    flex-direction: column;
                                    gap: 0.25rem;
                                }
                                #profissionaisTable .action-buttons .btn {
                                    width: 100%;
                                    margin: 0.1rem 0;
                                }
                            }
                        </style>
                        <table class="table mb-0" id="profissionaisTable">
                            <thead>
                                <tr>
                                    <th style="width: 10%;">ID</th>
                                    <th style="width: 35%;">Nome</th>
                                    <th style="width: 20%;">Telefone</th>
                                    <th style="width: 15%; text-align: center;">Status</th>
                                    <th style="width: 20%; text-align: center;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="profissionaisTableBody">
                                <!-- Dados serão carregados via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer bg-white d-flex justify-content-between align-items-center">
                    <div class="text-muted small">
                        Mostrando <span id="showingFrom">0</span> a <span id="showingTo">0</span> de <span id="totalProfissionais">0</span> profissional(s)
                    </div>
                    <nav aria-label="Navegação de páginas">
                        <ul class="pagination pagination-sm mb-0">
                            <!-- A navegação será preenchida dinamicamente pelo JavaScript -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Adicionar/Editar Profissional -->
    <div class="modal fade" id="addProfissionalModal" tabindex="-1" aria-labelledby="addProfissionalModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg" style="max-width: 800px;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addProfissionalModalLabel">Adicionar Novo Profissional</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <form id="profissionalForm">
                    <div class="modal-body">
                        <input type="hidden" id="profissionalId">
                        <div class="mb-3">
                            <label for="profissionalName" class="form-label">Nome Completo</label>
                            <input type="text" class="form-control" id="profissionalName" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="profissionalEmail" class="form-label">E-mail</label>
                                <input type="email" class="form-control" id="profissionalEmail">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="profissionalPhone" class="form-label">Telefone</label>
                                <input type="tel" class="form-control" id="profissionalPhone">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="profissionalCellPhone" class="form-label">Celular</label>
                                <input type="tel" class="form-control" id="profissionalCellPhone">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="profissionalCpf" class="form-label">CPF</label>
                                <input type="text" class="form-control" id="profissionalCpf">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="profissionalRg" class="form-label">RG</label>
                                <input type="text" class="form-control" id="profissionalRg">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="profissionalBirthDate" class="form-label">Data de Nascimento</label>
                                <input type="date" class="form-control" id="profissionalBirthDate">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="profissionalSpecialty" class="form-label">Especialidade</label>
                                <input type="text" class="form-control" id="profissionalSpecialty">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="profissionalRegister" class="form-label">Registro Profissional</label>
                                <input type="text" class="form-control" id="profissionalRegister">
                            </div>
                            <div class="col-12 mb-3">
                                <label for="profissionalSpecialties" class="form-label">Especialidades (separadas por vírgula)</label>
                                <input type="text" class="form-control" id="profissionalSpecialties" placeholder="Ex: Cardiologia, Clínico Geral, Pediatria">
                                <div class="form-text">Informe as especialidades separadas por vírgula</div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="profissionalStreet" class="form-label">Rua</label>
                            <input type="text" class="form-control" id="profissionalStreet">
                        </div>
                        <div class="row">
                            <div class="col-md-2 mb-3">
                                <label for="profissionalNumber" class="form-label">Número</label>
                                <input type="text" class="form-control" id="profissionalNumber">
                            </div>
                            <div class="col-md-5 mb-3">
                                <label for="profissionalNeighborhood" class="form-label">Bairro</label>
                                <input type="text" class="form-control" id="profissionalNeighborhood">
                            </div>
                            <div class="col-md-5 mb-3">
                                <label for="profissionalCity" class="form-label">Cidade</label>
                                <input type="text" class="form-control" id="profissionalCity">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="profissionalState" class="form-label">UF</label>
                                <select class="form-select" id="profissionalState" style="min-width: 80px;">
                                    <option value="">Selecione...</option>
                                    <option value="AC">AC</option>
                                    <option value="AL">AL</option>
                                    <option value="AP">AP</option>
                                    <option value="AM">AM</option>
                                    <option value="BA">BA</option>
                                    <option value="CE">CE</option>
                                    <option value="DF">DF</option>
                                    <option value="ES">ES</option>
                                    <option value="GO">GO</option>
                                    <option value="MA">MA</option>
                                    <option value="MT">MT</option>
                                    <option value="MS">MS</option>
                                    <option value="MG">MG</option>
                                    <option value="PA">PA</option>
                                    <option value="PB">PB</option>
                                    <option value="PR">PR</option>
                                    <option value="PE">PE</option>
                                    <option value="PI">PI</option>
                                    <option value="RJ">RJ</option>
                                    <option value="RN">RN</option>
                                    <option value="RS">RS</option>
                                    <option value="RO">RO</option>
                                    <option value="RR">RR</option>
                                    <option value="SC">SC</option>
                                    <option value="SP">SP</option>
                                    <option value="SE">SE</option>
                                    <option value="TO">TO</option>
                                </select>
                            </div>
                            <div class="col-md-5 mb-3">
                                <label for="profissionalZipCode" class="form-label">CEP</label>
                                <input type="text" class="form-control" id="profissionalZipCode">
                            </div>
                            <div class="col-md-5 mb-3">
                                <label for="profissionalComplement" class="form-label">Complemento</label>
                                <input type="text" class="form-control" id="profissionalComplement">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="profissionalNotes" class="form-label">Observações</label>
                            <textarea class="form-control" id="profissionalNotes" rows="3"></textarea>
                        </div>
                        <div class="form-group mb-3">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="profissionalStatus">
                                <option value="ATIVO">Ativo</option>
                                <option value="INATIVO">Inativo</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Salvar Profissional</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação de Exclusão -->
    <div class="modal fade" id="deleteProfissionalModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmar Exclusão</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <p>Tem certeza que deseja excluir este profissional? Esta ação não pode ser desfeita.</p>
                    <p class="mb-0"><strong>Profissional:</strong> <span id="profissionalToDelete"></span></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmDelete">Excluir</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    
    <script>
        // Variáveis globais
        let profissionais = [];
        let filteredProfissionais = [];
        let currentPage = 1;
        const itemsPerPage = 10; // Exibir 10 profissionais por página
        let showInactiveProfissionais = false;
        
        // Inicialização quando o DOM estiver pronto
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar máscaras
            $('#profissionalPhone').mask('(00) 00000-0000');
            $('#profissionalZipCode').mask('00000-000');
            
            // Carregar profissionais
            loadProfissionais();
            
            // Configurar eventos
            setupEventListeners();
            
            // Inicializar DataTable
            initDataTable();
            
            // Configurar menu mobile
            setupMobileMenu();
            
            // Verificar autenticação
            checkAuth();
        });
        
        // Função para obter o token JWT do localStorage
        function getAuthToken() {
            const token = localStorage.getItem('token');
            console.log('Token recuperado do localStorage:', token ? 'Presente' : 'Ausente');
            if (!token) {
                console.warn('Nenhum token encontrado no localStorage');
        }
        return token;
    }

    // Função para verificar autenticação
    function checkAuth() {
        console.log('Verificando autenticação...');
        const token = getAuthToken();
        
        if (!token) {
            console.warn('Usuário não autenticado, redirecionando para login...');
            window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.pathname);
            return false;
        }
        
        try {
            // Verificar se o token é válido (opcional, pode ser verificado no servidor)
            const payload = JSON.parse(atob(token.split('.')[1]));
            const isExpired = payload.exp * 1000 < Date.now();
            
            if (isExpired) {
                console.warn('Token expirado, redirecionando para login...');
                localStorage.removeItem('token');
                window.location.href = 'login.html?session=expired';
                return false;
            }
            
            console.log('Usuário autenticado com sucesso');
            return true;
        } catch (error) {
            console.error('Erro ao verificar token:', error);
            localStorage.removeItem('token');
            window.location.href = 'login.html?error=invalid_token';
            return false;
        }
    }

        // Função para fazer requisições autenticadas
        async function fetchWithAuth(url, options = {}) {
            const token = getAuthToken();
            console.log('Token recuperado do localStorage:', token ? 'Presente' : 'Ausente');
            
            // Garante que headers exista e seja um objeto
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };

            // Adiciona o token apenas se existir
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
                
                // Decodifica o token para obter o ID e a role do usuário
                try {
                    const tokenData = JSON.parse(atob(token.split('.')[1]));
                    const userId = tokenData.id || '';
                    const userRole = tokenData.role || '';
                    console.log('Dados do token - ID:', userId, 'Role:', userRole);
                    
                    // Adiciona os dados do usuário aos headers
                    headers['X-User-Id'] = userId;
                    headers['X-User-Role'] = userRole;
                } catch (e) {
                    console.warn('Erro ao decodificar token:', e);
                    // Se não conseguir decodificar o token, remove do localStorage
                    localStorage.removeItem('token');
                    window.location.href = 'login.html';
                    return Promise.reject('Token inválido');
                }
            }

            try {
                console.log(`Enviando requisição para: ${url}`);
                console.log('Headers da requisição:', JSON.stringify(headers, null, 2));
                
                const response = await fetch(url, {
                    ...options,
                    headers,
                    credentials: 'include',
                    mode: 'cors' // Adiciona o modo CORS explicitamente
                });
                
                console.log('Resposta recebida:', response.status, response.statusText);

                // Se for erro de autenticação
                if (response.status === 401) {
                    localStorage.removeItem('token');
                    window.location.href = 'login.html';
                    return null;
                }

                // Tenta extrair o conteúdo da resposta
                let responseData = null;
                const contentType = response.headers.get('content-type');
                
                try {
                    // Só tenta extrair o conteúdo se a resposta tiver corpo
                    if (response.body) {
                        const contentLength = response.headers.get('content-length');
                        if (contentLength === '0' || response.status === 204) {
                            return {}; // Resposta vazia ou No Content
                        }
                        
                        // Tenta extrair o JSON se o content-type for application/json
                        if (contentType && contentType.includes('application/json')) {
                            responseData = await response.json();
                        } else {
                            // Se não for JSON, tenta extrair como texto
                            const text = await response.text();
                            if (text) {
                                // Tenta converter para JSON se parecer JSON
                                try {
                                    responseData = JSON.parse(text);
                                } catch (e) {
                                    responseData = text;
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.warn('Não foi possível extrair o conteúdo da resposta:', error);
                    // Se não conseguir extrair, tenta obter o status da resposta
                    if (!response.ok) {
                        throw new Error(`Erro na requisição: ${response.status} ${response.statusText || ''}`);
                    }
                }

                // Se a resposta não for bem-sucedida
                if (!response.ok) {
                    let errorMessage = 'Erro ao processar a requisição';
                    
                    // Tenta obter a mensagem de erro da resposta
                    if (responseData) {
                        if (typeof responseData === 'string') {
                            errorMessage = responseData;
                        } else if (responseData.message) {
                            errorMessage = responseData.message;
                        } else if (responseData.error) {
                            // Se o erro for um objeto, tenta extrair a mensagem
                            if (typeof responseData.error === 'object' && responseData.error !== null) {
                                errorMessage = responseData.error.message || JSON.stringify(responseData.error);
                            } else {
                                errorMessage = responseData.error;
                            }
                        }
                    }
                    
                    // Se for um erro de validação, tenta extrair mensagens mais específicas
                    if (response.status === 400) {
                        if (responseData && responseData.errors) {
                            // Se houver erros de validação, junta todos em uma mensagem
                            const validationErrors = Object.values(responseData.errors)
                                .map(err => Array.isArray(err) ? err.join(', ') : err)
                                .join('; ');
                            
                            if (validationErrors) {
                                errorMessage = `Erro de validação: ${validationErrors}`;
                            }
                        } else if (responseData && responseData.message) {
                            // Se houver uma mensagem específica, usa ela
                            errorMessage = responseData.message;
                        }
                    }
                    
                    // Adiciona o status do erro se disponível (exceto para erros 400 que já tem mensagem específica)
                    if (response.status && response.status !== 400) {
                        errorMessage += ` (${response.status} ${response.statusText || ''})`;
                    }
                    
                    throw new Error(errorMessage);
                }

                // Retorna os dados da resposta ou um objeto vazio se não houver dados
                return responseData || {};
            } catch (error) {
                console.error('Erro na requisição:', error);
                Swal.fire({
                    title: 'Erro!',
                    text: error.message || 'Ocorreu um erro ao processar sua solicitação',
                    icon: 'error',
                    confirmButtonColor: '#f0b354'
                });
                throw error;
            }
        }

        // Função para carregar profissionais da API
        async function loadProfissionais() {
            try {
                console.log('Iniciando carregamento de profissionais...');
                // Fazendo a requisição para a API
                const response = await fetchWithAuth('/api/profissionais/my-professionals?limit=100&page=1');
                console.log('Resposta da API:', response);
                
                if (response && response.data) {
                    console.log('Total de profissionais recebidos:', response.data.length);
                    
                    // Mapeia os dados recebidos para o formato esperado
                    profissionais = response.data.map(profissional => ({
                        id: profissional.id,
                        nome: profissional.nome || 'Nome não informado',
                        email: profissional.email || 'Não informado',
                        telefone: profissional.telefone || 'Não informado',
                        rua: profissional.rua || '',
                        numero: profissional.numero || '',
                        complemento: profissional.complemento || '',
                        bairro: profissional.bairro || '',
                        cidade: profissional.cidade || '',
                        estado: profissional.estado || '',
                        cep: profissional.cep || '',
                        cpf: profissional.cpf || '',
                        dataNascimento: profissional.dataNascimento || null,
                        observacoes: profissional.observacoes || '',
                        status: profissional.status || 'ACTIVE',
                        createdAt: profissional.createdAt || new Date().toISOString()
                    }));
                    
                    console.log('Profissionais mapeados:', profissionais);
                    
                    // Atualiza a interface do usuário
                    renderProfissionaisTable();
                    updatePagination();
                } else {
                    console.error('Resposta da API inválida ou sem dados:', response);
                    throw new Error('Não foi possível carregar os profissionais. Tente novamente mais tarde.');
                }
            } catch (error) {
                console.error('Erro ao carregar profissionais:', error);
            }
        }
        
        // Função para renderizar a tabela de profissionais
        function renderProfissionaisTable() {
            const tbody = document.getElementById('profissionaisTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            try {
                // Verificar se existem profissionais para exibir
                if (!profissionais || profissionais.length === 0) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td colspan="5" class="text-center py-3">
                            Nenhum profissional encontrado.
                        </td>
                    `;
                    tbody.appendChild(tr);
                    return;
                }

                // Mostrar todos os profissionais sem filtrar por status
                filteredProfissionais = [...profissionais]; // Cria uma cópia do array de profissionais
                const totalFilteredProfissionais = filteredProfissionais.length;
                console.log(`Total de profissionais encontrados: ${totalFilteredProfissionais}`);
                
                // Calcular índices para a paginação
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                const paginatedProfissionais = filteredProfissionais.slice(startIndex, endIndex);
                
                // Atualizar contadores na interface
                updatePagination();
                
                // Exibir apenas os profissionais da página atual
                paginatedProfissionais.forEach(profissional => {
                    const tr = document.createElement('tr');
                    
                    // Formatar dados para exibição
                    const nome = profissional.nome || 'Não informado';
                    const email = profissional.email || 'N/A';
                    const telefone = profissional.telefone || 'N/A';
                    const status = profissional.status || 'ATIVO';
                    
                    // Criar a linha da tabela
                    tr.innerHTML = `
                        <td>#${String(profissional.id).padStart(4, '0')}</td>
                        <td>
                            <div>
                                <h6 class="mb-0">${nome}</h6>
                                <small class="text-muted d-block text-truncate" style="max-width: 250px;" title="${email}">${email}</small>
                            </div>
                        </td>
                        <td>${formatarTelefone(telefone)}</td>
                        <td style="text-align: center;">
                            <span class="badge ${status === 'ATIVO' || status === 'ACTIVE' ? 'bg-success' : 'bg-secondary'}">
                                ${status === 'ATIVO' || status === 'ACTIVE' ? 'Ativo' : 'Inativo'}
                            </span>
                        </td>
                        <td style="text-align: center;">
                            <div class="action-buttons justify-content-center">
                                <button class="btn btn-sm btn-outline-primary view-profissional" data-id="${profissional.id}" title="Visualizar">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-warning edit-profissional" data-id="${profissional.id}" title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-profissional" data-id="${profissional.id}" data-name="${(nome).replace(/"/g, '&quot;')}" title="Excluir">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    tbody.appendChild(tr);
                });
                
                // Adicionar eventos aos botões
                addProfissionalButtonEvents();
                
            } catch (error) {
                console.error('Erro ao renderizar a tabela de profissionais:', error);
                
                // Mostrar mensagem de erro na interface
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td colspan="5" class="text-center text-danger py-3">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        Ocorreu um erro ao carregar os profissionais. Por favor, tente novamente.
                    </td>
                `;
                tbody.appendChild(tr);
            }
        }
        
        // Função auxiliar para formatar telefone
        function formatarTelefone(telefone) {
            if (!telefone) return 'N/A';
            // Remove tudo que não for dígito
            const numeros = telefone.replace(/\D/g, '');
            
            // Formatação para celular (11 dígitos) com DDD
            if (numeros.length === 11) {
                return `(${numeros.substring(0, 2)}) ${numeros.substring(2, 7)}-${numeros.substring(7)}`;
            }
            // Formatação para telefone fixo (10 dígitos) com DDD
            if (numeros.length === 10) {
                return `(${numeros.substring(0, 2)}) ${numeros.substring(2, 6)}-${numeros.substring(6)}`;
            }
            // Retorna o número sem formatação se não atender aos padrões
            return telefone;
        }
        
        // Função para formatar CPF (usada em outros lugares do código)
        function formatCPF(cpf) {
            if (!cpf) return 'N/A';
            // Remove tudo que não for dígito
            const numeros = cpf.replace(/\D/g, '');
            // Aplica a formatação do CPF: 000.000.000-00
            return numeros.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
        }
        
        // Função para obter a classe do badge de status (usada em outros lugares do código)
        function getStatusBadgeClass(status) {
            if (!status) return 'bg-secondary';
            switch(status.toUpperCase()) {
                case 'ATIVO':
                case 'ACTIVE':
                    return 'bg-success';
                case 'INATIVO':
                case 'INACTIVE':
                    return 'bg-secondary';
                case 'PENDENTE':
                case 'PENDING':
                    return 'bg-warning';
                case 'BLOQUEADO':
                case 'BLOCKED':
                    return 'bg-danger';
                default:
                    return 'bg-secondary';
            }
        }
        
        // Função para obter o texto do status (usada em outros lugares do código)
        function getStatusText(status) {
            if (!status) return 'Desconhecido';
            
            const statusMap = {
                'ATIVO': 'Ativo',
                'ACTIVE': 'Ativo',
                'INATIVO': 'Inativo',
                'INACTIVE': 'Inativo',
                'PENDENTE': 'Pendente',
                'PENDING': 'Pendente',
                'BLOQUEADO': 'Bloqueado',
                'BLOCKED': 'Bloqueado'
            };
            
            return statusMap[status.toUpperCase()] || 'Desconhecido';
        }
        
        // Função para alterar o status de um profissional
        async function alterarStatusProfissional(id, novoStatus) {
            try {
                // Garante que o status esteja em maiúsculas
                const statusFormatado = novoStatus ? novoStatus.toUpperCase() : 'ATIVO';
                
                const confirmMessage = statusFormatado === 'INATIVO' 
                    ? 'Tem certeza que deseja inativar este profissional?' 
                    : 'Tem certeza que deseja ativar este profissional?';
                
                const result = await Swal.fire({
                    title: 'Confirmar alteração',
                    text: confirmMessage,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Sim, alterar',
                    cancelButtonText: 'Cancelar',
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    allowEnterKey: false
                });

                if (!result.isConfirmed) {
                    return;
                }

                console.log(`Atualizando status do profissional ${id} para ${statusFormatado}`);
                
                // Usando a rota específica para atualização de status
                const response = await fetchWithAuth(`${API_BASE_URL}/api/profissionais/${id}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        status: statusFormatado
                    })
                });

                console.log('Resposta da API:', response);

                if (!response) {
                    throw new Error('Não foi possível conectar ao servidor');
                }

                const responseData = await response.json();
                
                if (!response.ok) {
                    // Tratamento de erros específicos
                    if (responseData.error === 'AGENDAMENTOS_FUTUROS') {
                        const details = responseData.details || 'Existem agendamentos futuros para este profissional.';
                        const agendamentos = responseData.agendamentos || [];
                        
                        let html = `<div class="text-start">
                            <p>${details}</p>
                            ${agendamentos.length > 0 ? 
                                `<p class="mt-3"><strong>Próximos agendamentos:</strong></p>
                                <ul class="list-group mb-3">
                                    ${agendamentos.map(ag => 
                                        `<li class="list-group-item">
                                            <strong>${ag.cliente}</strong> - 
                                            ${new Date(ag.data).toLocaleString()}<br>
                                            <small class="text-muted">${ag.telefone || 'Sem telefone'}</small>
                                        </li>`
                                    ).join('')}
                                </ul>
                                <p class="text-muted">Total de agendamentos futuros: ${responseData.totalAgendamentos || agendamentos.length}</p>`
                            : ''}
                        </div>`;
                        
                        await Swal.fire({
                            icon: 'error',
                            title: 'Não é possível inativar',
                            html: html,
                            confirmButtonText: 'Entendi',
                            confirmButtonColor: '#dc3545',
                            width: '600px'
                        });
                        return;
                    }
                    
                    throw new Error(responseData.message || 'Erro ao atualizar status do profissional');
                }

                await Swal.fire({
                    icon: 'success',
                    title: 'Sucesso!',
                    html: `Status do profissional atualizado para <strong>${statusFormatado === 'ATIVO' ? 'Ativo' : 'Inativo'}</strong>`,
                    confirmButtonColor: '#198754',
                    timer: 2000,
                    timerProgressBar: true
                });

                // Fecha o modal se estiver aberto
                const modal = bootstrap.Modal.getInstance(document.getElementById('addProfissionalModal'));
                if (modal) {
                    modal.hide();
                }

                // Recarrega a lista de profissionais
                await loadProfissionais();

            } catch (error) {
                console.error('Erro ao alterar status do profissional:', error);
                
                let errorMessage = error.message || 'Ocorreu um erro ao alterar o status do profissional';
                
                // Mensagens de erro mais amigáveis
                if (errorMessage.includes('AGENDAMENTOS_FUTUROS')) {
                    errorMessage = 'Não é possível inativar o profissional pois existem agendamentos futuros.';
                } else if (errorMessage.includes('VALIDATION_ERROR')) {
                    errorMessage = 'Dados inválidos. Verifique as informações e tente novamente.';
                } else if (errorMessage.includes('NAO_AUTORIZADO') || errorMessage.includes('ACESSO_NEGADO')) {
                    errorMessage = 'Você não tem permissão para realizar esta ação.';
                } else if (errorMessage.includes('PROFISSIONAL_NAO_ENCONTRADO')) {
                    errorMessage = 'Profissional não encontrado. Ele pode ter sido removido por outro usuário.';
                }
                
                await Swal.fire({
                    icon: 'error',
                    title: 'Erro',
                    html: `<div class="text-danger">${errorMessage}</div>`,
                    confirmButtonColor: '#dc3545',
                    confirmButtonText: 'Entendi',
                    allowOutsideClick: false
                });
            }
        }

        // Função para configurar eventos dos botões da tabela
        function addProfissionalButtonEvents() {
            // Visualizar profissional
            document.querySelectorAll('.view-profissional').forEach(btn => {
                btn.addEventListener('click', function() {
                    const profissionalId = parseInt(this.getAttribute('data-id'));
                    viewProfissional(profissionalId);
                });
            });
            
            // Editar profissional
            document.querySelectorAll('.edit-profissional').forEach(btn => {
                btn.addEventListener('click', function() {
                    const profissionalId = parseInt(this.getAttribute('data-id'));
                    editProfissional(profissionalId);
                });
            });
            
            // Excluir profissional
            document.querySelectorAll('.delete-profissional').forEach(btn => {
                btn.addEventListener('click', function() {
                    const profissionalId = parseInt(this.getAttribute('data-id'));
                    const profissionalName = this.getAttribute('data-name');
                    showDeleteConfirmation(profissionalId, profissionalName);
                });
            });
        }
        
        // Função para visualizar profissional
        async function viewProfissional(profissionalId) {
            try {
                console.log(`Buscando detalhes do profissional com ID: ${profissionalId}`);
                
                // Faz a requisição para a API de profissionais
                const response = await fetchWithAuth(`/api/profissionais/${profissionalId}`);
                
                // Verifica se a resposta contém os dados do profissional
                if (!response) {
                    throw new Error('Resposta vazia da API');
                }
                
                console.log('Resposta da API de detalhes:', response);
                
                // Extrai os dados do profissional da resposta
                const profissional = response.data || response;
                
                if (profissional && Object.keys(profissional).length > 0) {
                    // Formatar telefones
                    const telefoneFormatado = profissional.telefone ? formatarTelefone(profissional.telefone) : 'Não informado';
                    const celularFormatado = profissional.celular ? formatarTelefone(profissional.celular) : 'Não informado';
                    
                    // Formatar endereço completo
                    const enderecoCompleto = [
                        profissional.rua,
                        profissional.numero,
                        profissional.complemento,
                        profissional.bairro
                    ].filter(Boolean).join(', ');
                    
                    // Formatar cidade/UF
                    const cidadeUf = [
                        profissional.cidade,
                        profissional.estado ? `/${profissional.estado}` : ''
                    ].filter(Boolean).join(' ');
                    
                    // Formatar CEP
                    const cepFormatado = profissional.cep ? 
                        profissional.cep.replace(/^(\d{5})(\d{3})$/, '$1-$2') : 'Não informado';
                    
                    // Formatar CPF
                    const cpfFormatado = profissional.cpf ? 
                        profissional.cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4') : 'Não informado';
                    
                    // Formatar RG
                    const rgFormatado = profissional.rg ? 
                        profissional.rg.replace(/^(\d{2})(\d{3})(\d{3})(\d{1})$/, '$1.$2.$3-$4') : 'Não informado';
                    
                    // Formatar data de nascimento
                    const dataNascimentoFormatada = profissional.dataNascimento ? 
                        formatDate(profissional.dataNascimento) : 'Não informada';
                    
                    // Formatar data de cadastro
                    const dataCadastroFormatada = profissional.criadoEm ? 
                        formatDate(profissional.criadoEm) : 'Não disponível';
                    
                    // Monta o HTML com os dados do profissional
                    const htmlContent = `
                        <div class="text-start">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <h5 class="mb-0">Informações Pessoais</h5>
                                <span class="badge ${getStatusBadgeClass(profissional.status)}">
                                    ${getStatusText(profissional.status)}
                                </span>
                            </div>
                            <hr class="my-2">
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Nome:</strong> ${profissional.nome || 'Não informado'}</p>
                                    <p><strong>CPF:</strong> ${cpfFormatado}</p>
                                    <p><strong>RG:</strong> ${rgFormatado}</p>
                                    <p><strong>Data de Nascimento:</strong> ${dataNascimentoFormatada}</p>
                                    <p><strong>E-mail:</strong> ${profissional.email || 'Não informado'}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Telefone:</strong> ${telefoneFormatado}</p>
                                    <p><strong>Celular:</strong> ${celularFormatado}</p>
                                    <p><strong>Registro:</strong> ${profissional.registro || 'Não informado'}</p>
                                    <p><strong>Especialidade:</strong> ${profissional.especialidade || 'Não informada'}</p>
                                </div>
                            </div>
                            
                            <h5 class="mt-4 mb-2">Endereço</h5>
                            <hr class="my-2">
                            <p>${enderecoCompleto || 'Endereço não informado'}</p>
                            <p>${cidadeUf || ''} ${cepFormatado ? `- ${cepFormatado}` : ''}</p>
                            
                            ${profissional.observacoes ? `
                                <h5 class="mt-4 mb-2">Observações</h5>
                                <hr class="my-2">
                                <p>${profissional.observacoes}</p>
                            ` : ''}
                            
                            <div class="text-muted small mt-3">
                                <p class="mb-0">Cadastrado em: ${dataCadastroFormatada}</p>
                            </div>
                        </div>
                    `;
                    
                    // Exibe o modal com os detalhes do profissional
                    Swal.fire({
                        title: profissional.nome || 'Profissional',
                        html: htmlContent,
                        confirmButtonText: 'Fechar',
                        confirmButtonColor: '#f0b354',
                        showCloseButton: true,
                        width: '700px',
                        customClass: {
                            popup: 'text-start'
                        }
                    });
                } else {
                    throw new Error('Dados do profissional não encontrados na resposta da API');
                }
            } catch (error) {
                console.error('Erro ao carregar detalhes do profissional:', error);
                showError('Erro', `Não foi possível carregar os detalhes do profissional: ${error.message}`);
            }
        }
        
        // Função para carregar os detalhes de um profissional
        async function loadProfissionalDetails(profissionalId) {
            try {
                console.log(`Carregando detalhes do profissional ID: ${profissionalId}`);
                const response = await fetchWithAuth(`/api/profissionais/${profissionalId}`);
                
                if (!response) {
                    throw new Error('Resposta vazia da API');
                }
                
                // Extrai os dados do profissional da resposta
                const profissional = response.data || response;
                console.log('Dados do profissional recebidos:', profissional);
                
                if (profissional && Object.keys(profissional).length > 0) {
                    // Função para formatar data para o input type="date"
                    const formatDateForInput = (dateString) => {
                        if (!dateString) return '';
                        try {
                            const date = new Date(dateString);
                            // Verifica se a data é válida
                            if (isNaN(date.getTime())) return '';
                            return date.toISOString().split('T')[0];
                        } catch (e) {
                            console.error('Erro ao formatar data:', e);
                            return '';
                        }
                    };
                    
                    // Primeiro, definimos o status antes de preencher os outros campos
                    const statusMap = {
                        'ACTIVE': 'ATIVO',
                        'INACTIVE': 'INATIVO',  // Corrigindo o mapeamento para 'INATIVO'
                        'PENDING': 'PENDENTE',
                        'BLOCKED': 'BLOQUEADO',
                        // Adicionando mapeamento em português para garantir compatibilidade
                        'ATIVO': 'ATIVO',
                        'INATIVO': 'INATIVO',
                        'PENDENTE': 'PENDENTE',
                        'BLOQUEADO': 'BLOQUEADO'
                    };
                    
                    // Definir o status do profissional primeiro
                    const statusSelect = document.getElementById('profissionalStatus');
                    if (statusSelect) {
                        const statusUpper = (profissional.status || '').toUpperCase();
                        const statusPtBr = statusMap[statusUpper] || 'ATIVO';
                        
                        console.log('Definindo status para:', {
                            original: profissional.status,
                            upper: statusUpper,
                            mapped: statusPtBr
                        });
                        
                        statusSelect.value = statusPtBr;
                    }
                    
                    // Mapeamento dos campos do formulário
                    const fieldMappings = {
                        'profissionalId': profissional.id,
                        'profissionalName': profissional.nome,
                        'profissionalEmail': profissional.email,
                        'profissionalPhone': profissional.telefone,
                        'profissionalCellPhone': profissional.celular,
                        'profissionalRg': profissional.rg,
                        'profissionalCpf': profissional.cpf ? 
                            profissional.cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4') : '',
                        'profissionalBirthDate': formatDateForInput(profissional.dataNascimento),
                        'profissionalStreet': profissional.rua,
                        'profissionalNumber': profissional.numero,
                        'profissionalComplement': profissional.complemento,
                        'profissionalNeighborhood': profissional.bairro,
                        'profissionalCity': profissional.cidade,
                        'profissionalState': profissional.estado,
                        'profissionalZipCode': profissional.cep ? 
                            profissional.cep.replace(/(\d{5})(\d{3})/, '$1-$2') : '',
                        'profissionalSpecialty': profissional.especialidade,
                        'profissionalRegister': profissional.registro,
                        'profissionalNotes': profissional.observacoes,
                        'profissionalSpecialties': Array.isArray(profissional.especialidades) ? 
                            profissional.especialidades.join(', ') : ''
                    };
                    
                    // Preencher os campos do formulário
                    Object.entries(fieldMappings).forEach(([fieldId, value]) => {
                        const element = document.getElementById(fieldId);
                        if (element) {
                            element.value = value || '';
                            
                            // Disparar evento de mudança para campos que possuem máscaras ou validações
                            if (['profissionalCpf', 'profissionalZipCode', 'profissionalPhone', 'profissionalCellPhone'].includes(fieldId)) {
                                const event = new Event('input', { bubbles: true });
                                element.dispatchEvent(event);
                            }
                        } else {
                            console.warn(`Elemento não encontrado: ${fieldId}`);
                        }
                    });
                    
                    // O status já foi definido no início da função
                    // Aqui garantimos que o valor está correto após o preenchimento dos outros campos
                    if (statusSelect) {
                        console.log('Verificando status após preenchimento:', {
                            currentValue: statusSelect.value,
                            expectedValue: statusMap[(profissional.status || '').toUpperCase()] || 'ATIVO'
                        });
                        
                        // Força a atualização do valor se necessário
                        const statusUpper = (profissional.status || '').toUpperCase();
                        const expectedValue = statusMap[statusUpper] || 'ATIVO';
                        
                        if (statusSelect.value !== expectedValue) {
                            console.warn('O valor do status foi alterado após o preenchimento do formulário. Corrigindo...');
                            statusSelect.value = expectedValue;
                            
                            // Dispara evento de mudança para garantir que a UI seja atualizada
                            const event = new Event('change', { bubbles: true });
                            statusSelect.dispatchEvent(event);
                        }
                    }
                    
                    // Atualizar o título do modal
                    const modalTitle = document.getElementById('addProfissionalModalLabel');
                    if (modalTitle) {
                        modalTitle.textContent = 'Editar Profissional';
                    }
                    
                    // Abrir o modal
                    const modalElement = document.getElementById('addProfissionalModal');
                    if (modalElement) {
                        const modal = new bootstrap.Modal(modalElement);
                        modal.show();
                    } else {
                        console.error('Elemento do modal não encontrado');
                    }
                } else {
                    throw new Error('Dados do profissional não encontrados na resposta');
                }
            } catch (error) {
                console.error('Erro ao carregar detalhes do profissional:', error);
                showError(
                    'Erro ao carregar profissional', 
                    'Não foi possível carregar os detalhes do profissional. Por favor, tente novamente.'
                );
            }
        }
        
        // Função para editar profissional
        function editProfissional(profissionalId) {
            loadProfissionalDetails(profissionalId);
        }
        
        // Função para mostrar confirmação de exclusão
        function showDeleteConfirmation(profissionalId, profissionalName) {
            document.getElementById('profissionalToDelete').textContent = profissionalName;
            
            const modal = new bootstrap.Modal(document.getElementById('deleteProfissionalModal'));
            modal.show();
            
            document.getElementById('confirmDelete').onclick = function() {
                deleteProfissional(profissionalId);
                modal.hide();
            };
        }
        
        // Função para excluir profissional
        async function deleteProfissional(profissionalId) {
            try {
                console.log(`Iniciando exclusão do profissional ID: ${profissionalId}`);
                
                // Fazer a requisição DELETE
                const response = await fetchWithAuth(`/api/profissionais/${profissionalId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('Resposta da exclusão:', response);
                
                // Se chegou aqui, a requisição foi bem-sucedida (mesmo que a resposta seja vazia)
                // Remover o profissional da lista local
                profissionais = profissionais.filter(profissional => 
                    profissional.id.toString() !== profissionalId.toString()
                );
                
                console.log('Lista de profissionais após exclusão:', profissionais);
                
                // Atualizar a tabela
                renderProfissionaisTable();
                updatePagination();
                
                // Mostrar mensagem de sucesso
                showSuccess('Profissional excluído com sucesso!');
                
                // Fechar o modal de confirmação
                const modal = bootstrap.Modal.getInstance(document.getElementById('deleteProfissionalModal'));
                if (modal) modal.hide();
                
            } catch (error) {
                console.error('Erro ao excluir profissional:', error);
                Swal.fire({
                    title: 'Erro!',
                    text: error.message || 'Ocorreu um erro ao excluir o profissional',
                    icon: 'error',
                    confirmButtonColor: '#f0b354'
                });
            }
        }
        
        // Função para atualizar a exibição dos profissionais com paginação
        function updatePagination() {
            const totalProfissionais = filteredProfissionais ? filteredProfissionais.length : 0;
            const totalPages = Math.ceil(totalProfissionais / itemsPerPage);
            const paginationContainer = document.querySelector('.pagination');
            
            // Atualizar o texto de exibição com a contagem de profissionais
            const showingFromEl = document.getElementById('showingFrom');
            const showingToEl = document.getElementById('showingTo');
            const totalProfissionaisEl = document.getElementById('totalProfissionais');
            
            if (showingFromEl && showingToEl && totalProfissionaisEl) {
                const start = totalProfissionais > 0 ? ((currentPage - 1) * itemsPerPage) + 1 : 0;
                const end = Math.min(currentPage * itemsPerPage, totalProfissionais);
                
                showingFromEl.textContent = start;
                showingToEl.textContent = end;
                totalProfissionaisEl.textContent = totalProfissionais;
            }
            
            // Atualizar controles de paginação
            if (paginationContainer) {
                let paginationHTML = '';
                
                // Botão Anterior
                paginationHTML += `
                    <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                        <a class="page-link" href="#" id="prevPage">Anterior</a>
                    </li>
                `;
                
                // Números das páginas
                let startPage = Math.max(1, currentPage - 2);
                let endPage = Math.min(totalPages, startPage + 4);
                
                if (endPage - startPage < 4 && totalPages > 4) {
                    startPage = Math.max(1, endPage - 4);
                }
                
                for (let i = startPage; i <= endPage; i++) {
                    paginationHTML += `
                        <li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link page-number" href="#" data-page="${i}">${i}</a>
                        </li>
                    `;
                }
                
                // Botão Próximo
                paginationHTML += `
                    <li class="page-item ${currentPage >= totalPages ? 'disabled' : ''}">
                        <a class="page-link" href="#" id="nextPage">Próximo</a>
                    </li>
                `;
                
                paginationContainer.innerHTML = paginationHTML;
                paginationContainer.style.display = totalPages > 1 ? 'flex' : 'none';
                
                // Adicionar eventos aos botões de paginação
                document.getElementById('prevPage')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (currentPage > 1) {
                        currentPage--;
                        renderProfissionaisTable();
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                });
                
                document.getElementById('nextPage')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (currentPage < totalPages) {
                        currentPage++;
                        renderProfissionaisTable();
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                });
                
                document.querySelectorAll('.page-number').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const page = parseInt(e.target.getAttribute('data-page'));
                        if (page !== currentPage) {
                            currentPage = page;
                            renderProfissionaisTable();
                            window.scrollTo({ top: 0, behavior: 'smooth' });
                        }
                    });
                });
            }
        }
        
        // Função para obter a classe CSS do badge de status
        function getStatusBadgeClass(status) {
            const statusClasses = {
                'ACTIVE': 'bg-success',
                'INACTIVE': 'bg-secondary',
                'PENDING': 'bg-warning text-dark',
                'BLOCKED': 'bg-danger'
            };
            return statusClasses[status] || 'bg-secondary';
        }

        // Função para obter o texto do status
        function getStatusText(status) {
            const statusTexts = {
                'ACTIVE': 'Ativo',
                'INACTIVE': 'Inativo',
                'PENDING': 'Pendente',
                'BLOCKED': 'Bloqueado'
            };
            return statusTexts[status] || status;
        }

        // Função para limpar o formulário de profissional
        function resetProfissionalForm() {
            const form = document.getElementById('profissionalForm');
            const currentStatus = document.getElementById('profissionalStatus').value;
            
            form.reset();
            document.getElementById('profissionalId').value = '';
            
            // Restaura o status apenas se estiver vazio (não em edição)
            if (!document.getElementById('profissionalId').value) {
                document.getElementById('profissionalStatus').value = 'ATIVO';
            } else if (currentStatus) {
                document.getElementById('profissionalStatus').value = currentStatus;
            }
            
            // Atualiza o título do modal
            const modalTitle = document.getElementById('addProfissionalModalLabel');
            if (modalTitle) {
                modalTitle.textContent = 'Adicionar Novo Profissional';
            }
        }
        
        // Função para formatar data
        function formatDate(dateString) {
            if (!dateString) return '';
            
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return 'Data inválida';
                
                // Verificar se a data tem hora definida
                const hasTime = dateString.includes('T') || dateString.includes(' ');
                
                if (hasTime) {
                    return date.toLocaleString('pt-BR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } else {
                    return date.toLocaleDateString('pt-BR');
                }
            } catch (e) {
                console.error('Erro ao formatar data:', e);
                return dateString;
            }
        }
        
        // Função para configurar os listeners de eventos
        function setupEventListeners() {
            // Formulário de profissional
            const profissionalForm = document.getElementById('profissionalForm');
            if (profissionalForm) {
                profissionalForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveProfissional();
                });
            }
            
            // Botão de novo profissional (barra lateral)
            const newProfissionalBtn = document.querySelector('.btn-add-profissional');
            if (newProfissionalBtn) {
                newProfissionalBtn.addEventListener('click', function() {
                    resetProfissionalForm();
                    document.getElementById('addProfissionalModalLabel').textContent = 'Adicionar Novo Profissional';
                });
            }
            
            // Botão de novo profissional (ao lado da busca)
            const addProfissionalBtn = document.getElementById('addProfissionalBtn');
            if (addProfissionalBtn) {
                addProfissionalBtn.addEventListener('click', function() {
                    resetProfissionalForm();
                    const modal = new bootstrap.Modal(document.getElementById('addProfissionalModal'));
                    modal.show();
                });
            }
            
            // Busca na tabela
            const searchInput = document.getElementById('searchInput');
            let debounceTimer;
            
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value.trim();
                    clearTimeout(debounceTimer);
                    
                    debounceTimer = setTimeout(() => {
                        if (searchTerm.length > 1 || searchTerm.length === 0) {
                            filterProfissionais(searchTerm);
                        }
                    }, 300);
                });
                
                // Pesquisar ao pressionar Enter
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const searchTerm = this.value.trim();
                        if (searchTerm.length > 0) {
                            filterProfissionais(searchTerm);
                        }
                    }
                });
            }
        }
        

        // Função para filtrar profissionais na tabela
        function filterProfissionais(searchTerm) {
            currentPage = 1; // Reset para a primeira página ao filtrar
            const tbody = document.getElementById('profissionaisTableBody');
            tbody.innerHTML = '';
            
            // Se não houver termo de busca, exibe todos os profissionais ativos
            if (!searchTerm || searchTerm.trim() === '') {
                renderProfissionaisTable();
                return;
            }
            
            // Filtra os profissionais com base no termo de busca
            const filteredProfissionais = profissionais.filter(profissional => {
                const searchLower = searchTerm.toLowerCase();
                return (
                    (profissional.nome && profissional.nome.toLowerCase().includes(searchLower)) ||
                    (profissional.email && profissional.email.toLowerCase().includes(searchLower)) ||
                    (profissional.cpf && profissional.cpf.includes(searchTerm)) ||
                    (profissional.telefone && profissional.telefone.includes(searchTerm))
                );
            });
            
            // Se não encontrar resultados
            if (filteredProfissionais.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td colspan="5" class="text-center py-4">
                        <div class="text-muted">
                            <i class="bi bi-search display-5 d-block mb-2"></i>
                            Nenhum profissional encontrado para "${searchTerm}"
                        </div>
                    </td>`;
                tbody.appendChild(tr);
                
                // Atualizar informações de paginação
                document.getElementById('showingFrom').textContent = 0;
                document.getElementById('showingTo').textContent = 0;
                document.getElementById('totalProfissionais').textContent = 0;
                
                return;
            }
                        // Exibe os resultados da busca
            filteredProfissionais.forEach(profissional => {
                const tr = document.createElement('tr');
                const nome = profissional.nome || 'Não informado';
                const email = profissional.email || 'N/A';
                const telefone = profissional.telefone || 'N/A';
                const status = profissional.status || 'ATIVO';
                
                tr.innerHTML = `
                    <td>#${String(profissional.id).padStart(4, '0')}</td>
                    <td>
                        <div>
                            <h6 class="mb-0">${nome}</h6>
                            <small class="text-muted d-block text-truncate" style="max-width: 250px;" title="${email}">${email}</small>
                        </div>
                    </td>
                    <td>${formatarTelefone(telefone)}</td>
                    <td style="text-align: center;">
                        <span class="badge ${status === 'ATIVO' || status === 'ACTIVE' ? 'bg-success' : 'bg-secondary'}">
                            ${status === 'ATIVO' || status === 'ACTIVE' ? 'Ativo' : 'Inativo'}
                        </span>
                    </td>
                    <td style="text-align: center;">
                        <div class="action-buttons justify-content-center">
                            <button class="btn btn-sm btn-outline-primary view-profissional" data-id="${profissional.id}" title="Visualizar">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-warning edit-profissional" data-id="${profissional.id}" title="Editar">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger delete-profissional" data-id="${profissional.id}" data-name="${(nome).replace(/"/g, '&quot;')}" title="Excluir">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>`;
                tbody.appendChild(tr);
            });
            
            // Atualizar informações de paginação
            document.getElementById('showingFrom').textContent = 1;
            document.getElementById('showingTo').textContent = filteredProfissionais.length;
            document.getElementById('totalProfissionais').textContent = filteredProfissionais.length;
            
            // Adicionar eventos aos botões
            addProfissionalButtonEvents();
        }
        
        // Função para salvar profissional (adicionar ou atualizar)
        async function saveProfissional() {
            // Prevenir múltiplos envios
            const form = document.getElementById('profissionalForm');
            const submitButton = form.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.innerHTML;
            
            // Se já estiver processando, não faz nada
            if (form.dataset.submitting === 'true') {
                console.log('Formulário já está sendo processado');
                return;
            }
            
            // Marca o formulário como sendo processado
            form.dataset.submitting = 'true';
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Salvando...';
            
            // Limpa mensagens de erro anteriores
            document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            
            try {
                // Obter valores dos campos
                const id = document.getElementById('profissionalId').value;
                const nome = document.getElementById('profissionalName').value.trim();
                const email = document.getElementById('profissionalEmail').value.trim();
                const telefone = document.getElementById('profissionalPhone').value.trim();
                const celular = document.getElementById('profissionalCellPhone').value.trim();
                const cpfInput = document.getElementById('profissionalCpf');
                const cpf = cpfInput.value.trim();
                const cpfApenasNumeros = cpf.replace(/\D/g, '');
                const rg = document.getElementById('profissionalRg').value.trim();
                const dataNascimento = document.getElementById('profissionalBirthDate').value;
                const especialidade = document.getElementById('profissionalSpecialty').value.trim();
                const registro = document.getElementById('profissionalRegister').value.trim();
                const especialidadesInput = document.getElementById('profissionalSpecialties').value.trim();
                const especialidades = especialidadesInput.split(',').map(s => s.trim()).filter(s => s.length > 0);
                const rua = document.getElementById('profissionalStreet').value.trim();
                const numero = document.getElementById('profissionalNumber').value.trim();
                const complemento = document.getElementById('profissionalComplement').value.trim();
                const bairro = document.getElementById('profissionalNeighborhood').value.trim();
                const cidade = document.getElementById('profissionalCity').value.trim();
                const estado = document.getElementById('profissionalState').value;
                const cep = document.getElementById('profissionalZipCode').value.trim();
                const observacoes = document.getElementById('profissionalNotes').value.trim();
                // Obtém o status selecionado do formulário
                const status = document.getElementById('profissionalStatus').value || 'ATIVO';
                
                // Mapeia os status para inglês (apenas para o backend)
                const statusToEnglish = {
                    'ATIVO': 'ACTIVE',
                    'INATIVO': 'INACTIVE',
                    'PENDENTE': 'PENDING',
                    'BLOQUEADO': 'BLOCKED'
                };
                
                // Mapeia os status para português (apenas para o frontend)
                const statusToPortuguese = {
                    'ACTIVE': 'ATIVO',
                    'INACTIVE': 'INATIVO',
                    'PENDING': 'PENDENTE',
                    'BLOCKED': 'BLOQUEADO'
                };
                
                // Validação básica
                if (!nome) {
                    document.getElementById('profissionalName').classList.add('is-invalid');
                    throw new Error('O nome do profissional é obrigatório.');
                }
                
                // Validação de e-mail
                if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                    document.getElementById('profissionalEmail').classList.add('is-invalid');
                    throw new Error('Por favor, insira um e-mail válido.');
                }
            
                const profissionalData = {
                    nome,
                    email: email || null,
                    telefone: telefone || null,
                    celular: celular || null,
                    cpf: cpfApenasNumeros || null,
                    rg: rg || null,
                    dataNascimento: dataNascimento || null,
                    especialidade: especialidade || null,
                    registro: registro || null,
                    especialidades: especialidades.length > 0 ? especialidades : null,
                    rua: rua || null,
                    numero: numero || null,
                    complemento: complemento || null,
                    bairro: bairro || null,
                    cidade: cidade || null,
                    estado: estado || null,
                    cep: cep || null,
                    observacoes: observacoes || null,
                    status: status || 'ATIVO'
                };
                
                console.log('Dados do profissional a serem enviados:', JSON.stringify(profissionalData, null, 2));
                
                // Verifica se apenas o status está sendo alterado
                const form = document.getElementById('profissionalForm');
                const formData = new FormData(form);
                let isOnlyStatusChanged = true;
                
                // Verifica se apenas o status foi alterado
                formData.forEach((value, key) => {
                    if (key !== 'status' && key !== 'profissionalStatus' && value && value !== '') {
                        isOnlyStatusChanged = false;
                    }
                });
                
                // Se apenas o status foi alterado, usa PATCH para /status
                if (id && isOnlyStatusChanged) {
                    const status = document.getElementById('profissionalStatus').value;
                    const method = 'PATCH';
                    const url = `/api/profissionais/${id}/status`;
                    
                    console.log('Atualizando apenas o status via PATCH:', { status: status });
                    
                    const response = await fetchWithAuth(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ status: status })
                    });
                    
                    // A função fetchWithAuth já faz o parse do JSON e tratamento de erros
                    // Então se chegou aqui, a requisição foi bem-sucedida
                    
                    // Atualiza a interface
                    await showSuccess('Status do profissional atualizado com sucesso!');
                    await loadProfissionais();
                    
                    // Fecha o modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addProfissionalModal'));
                    if (modal) {
                        modal.hide();
                    }
                    
                    return;
                }
                
                // Se não for apenas atualização de status, prossegue com PUT normal
                const httpMethod = id ? 'PUT' : 'POST';
                const apiUrl = id ? `/api/profissionais/${id}` : '/api/profissionais';
                
                console.log('Método HTTP:', httpMethod, 'URL:', apiUrl, 'Dados:', profissionalData);
                
                const requestOptions = {
                    method: httpMethod,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getAuthToken()}`
                    },
                    body: JSON.stringify(profissionalData)
                };
                
                console.log(`Enviando requisição ${httpMethod} para ${apiUrl}`, requestOptions);
                
                let response;
                try {
                    response = await fetch(apiUrl, requestOptions);
                    
                    if (!response) {
                        throw new Error('Não foi possível completar a requisição: resposta vazia');
                    }
                    
                    console.log('Resposta da API recebida. Status:', response.status);
                    
                    // Processar a resposta da API
                    let responseData;
                    const contentType = response.headers.get('content-type');
                    
                    if (contentType && contentType.includes('application/json')) {
                        responseData = await response.json();
                    } else {
                        const text = await response.text();
                        responseData = text ? { message: text } : {};
                    }
                    
                    if (!response.ok) {
                        throw new Error(responseData.message || 'Erro ao processar a requisição');
                    }
                    
                    // Se chegou aqui, a requisição foi bem-sucedida
                    if (id) {
                        await showSuccess('Profissional atualizado com sucesso!');
                    } else {
                        await showSuccess('Profissional cadastrado com sucesso!');
                        currentPage = 1; // Voltar para a primeira página
                    }
                    
                    // Fechar o modal corretamente e remover o backdrop
                    const modalElement = document.getElementById('addProfissionalModal');
                    const modal = bootstrap.Modal.getInstance(modalElement);
                    
                    // Esconder o modal
                    if (modal) {
                        modal.hide();
                        // Remover o backdrop manualmente se necessário
                        const backdrop = document.querySelector('.modal-backdrop');
                        if (backdrop) {
                            backdrop.remove();
                        }
                        // Remover a classe 'modal-open' do body e restaurar o overflow
                        document.body.classList.remove('modal-open');
                        document.body.style.overflow = '';
                        document.body.style.paddingRight = '';
                    }
                    
                    // Recarregar a lista e resetar o formulário
                    await loadProfissionais();
                    resetProfissionalForm();
                    
                    return responseData;
                    
                } catch (error) {
                    console.error('Erro na requisição:', error);
                    throw error;
                }
                
            } catch (error) {
                console.error('Erro ao salvar profissional:', error);
                let errorMessage = 'Ocorreu um erro ao salvar o profissional';
                
                if (error && error.message) {
                    errorMessage = error.message;
                    
                    // Verifica se é um erro de CPF ou e-mail duplicado
                    const errorStr = String(error.message);
                    
                    if (errorStr.includes('Unique constraint failed on the fields: (`cpf`)') || 
                        errorStr.includes('Já existe um profissional com este CPF') ||
                        (errorStr.includes('E11000') && errorStr.includes('cpf_1'))) {
                        errorMessage = 'Já existe um profissional cadastrado com este CPF. Por favor, verifique os dados e tente novamente.';
                        const cpfField = document.getElementById('profissionalCpf');
                        if (cpfField) cpfField.classList.add('is-invalid');
                    } 
                    else if (errorStr.includes('Unique constraint failed on the fields: (`email`)') || 
                             errorStr.includes('Já existe um profissional com este e-mail') ||
                             (errorStr.includes('E11000') && errorStr.includes('email_1'))) {
                        errorMessage = 'Já existe um profissional cadastrado com este e-mail. Por favor, utilize outro e-mail.';
                        const emailField = document.getElementById('profissionalEmail');
                        if (emailField) emailField.classList.add('is-invalid');
                    }
                } 
                // Se for um objeto de erro da API
                else if (error && error.error) {
                    errorMessage = typeof error.error === 'string' ? error.error : 'Erro desconhecido';
                    if (error.field) {
                        const fieldId = `profissional${String(error.field).charAt(0).toUpperCase() + String(error.field).slice(1)}`;
                        const fieldElement = document.getElementById(fieldId);
                        if (fieldElement) {
                            fieldElement.classList.add('is-invalid');
                        } else {
                            console.warn(`Campo com ID '${fieldId}' não encontrado`);
                        }
                    }
                }
                
                // Exibe a mensagem de erro para o usuário
                await Swal.fire({
                    title: 'Erro ao salvar profissional!',
                    html: `
                        <div style="text-align: left;">
                            <p>${errorMessage}</p>
                            <p class="text-muted small mt-2">Verifique os dados informados e tente novamente.</p>
                        </div>
                    `,
                    icon: 'error',
                    confirmButtonColor: '#f0b354',
                    confirmButtonText: 'Entendi',
                    width: '500px',
                    didClose: () => {
                        // Foca no primeiro campo com erro
                        const invalidField = document.querySelector('.is-invalid');
                        if (invalidField) {
                            invalidField.focus();
                        }
                    }
                });
                
                // Re-throw para ser capturado pelo bloco catch externo se necessário
                throw error;
                
            } finally {
                // Restaurar o botão e o estado do formulário
                try {
                    if (form && typeof form.dataset !== 'undefined') {
                        form.dataset.submitting = 'false';
                    }
                    if (submitButton) {
                        submitButton.disabled = false;
                        if (originalButtonText) {
                            submitButton.innerHTML = originalButtonText;
                        } else {
                            submitButton.innerHTML = 'Salvar Profissional';
                        }
                    }
                } catch (cleanupError) {
                    console.error('Erro ao limpar o estado do formulário:', cleanupError);
                }
            }
    }
    
    // Função para resetar o formulário de profissional
        function resetProfissionalForm() {
            const form = document.getElementById('profissionalForm');
            const currentStatus = document.getElementById('profissionalStatus').value;
            
            form.reset();
            document.getElementById('profissionalId').value = '';
            
            // Restaura o status apenas se estiver vazio (não em edição)
            if (!document.getElementById('profissionalId').value) {
                document.getElementById('profissionalStatus').value = 'ATIVO';
            } else if (currentStatus) {
                document.getElementById('profissionalStatus').value = currentStatus;
            }
            
            // Atualiza o título do modal
            const modalTitle = document.getElementById('addProfissionalModalLabel');
            if (modalTitle) {
                modalTitle.textContent = 'Adicionar Novo Profissional';
            }
        }
        
        // Função para mostrar mensagem de sucesso
        function showSuccess(message) {
            Swal.fire({
                title: 'Sucesso!',
                text: message,
                icon: 'success',
                confirmButtonColor: '#f0b354',
                timer: 2000,
                timerProgressBar: true
            });
        }
        
        // Função para mostrar mensagem de erro
        function showError(title, message) {
            // Se a mensagem for muito longa, formata em um alerta maior com rolagem
            const isLongMessage = message && (message.length > 100 || message.includes('\n'));
            
            const swalOptions = {
                title: title || 'Erro',
                icon: 'error',
                confirmButtonText: 'Entendi',
                confirmButtonColor: '#dc3545',
                width: isLongMessage ? '600px' : undefined,
                customClass: {
                    confirmButton: 'btn btn-danger',
                    container: 'error-modal'
                },
                buttonsStyling: false
            };
            
            // Se for uma mensagem longa ou com múltiplas linhas, usa html em vez de text
            if (isLongMessage) {
                // Substitui quebras de linha por <br> e mantém o texto seguro
                const formattedMessage = message
                    .replace(/\n/g, '<br>')
                    .replace(/\*/g, '•')
                    .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');
                
                swalOptions.html = `
                    <div class="text-start" style="max-height: 60vh; overflow-y: auto; padding-right: 10px;">
                        <p>${formattedMessage}</p>
                        <p class="text-muted small mt-2">Se o problema persistir, entre em contato com o suporte.</p>
                    </div>
                `;
            } else {
                swalOptions.text = message;
            }
            
            return Swal.fire(swalOptions);
        }
        
        // Função para configurar a tabela
        function initDataTable() {
            // Configuração da busca
            const searchInput = document.getElementById('searchProfissional');
            
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    filterProfissionais(searchTerm);
                });
            }
        }
        
        // Função para configurar o menu mobile
        function setupMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebarOverlay = document.querySelector('.sidebar-overlay');
            
            // Verifica se os elementos existem antes de manipulá-los
            if (!sidebar || !sidebarToggle || !sidebarOverlay) {
                console.warn('Elementos do menu lateral não encontrados');
                return;
            }
            
            sidebarToggle.classList.remove('d-none');
            
            // Adiciona evento de clique no botão de toggle
            sidebarToggle.addEventListener('click', function() {
                if (sidebar && sidebarOverlay) {
                    sidebar.classList.toggle('active');
                    sidebarOverlay.style.display = sidebar.classList.contains('active') ? 'block' : 'none';
                    document.body.style.overflow = sidebar.classList.contains('active') ? 'hidden' : '';
                }
            });
            
            // Fecha o menu ao clicar no overlay
            sidebarOverlay.addEventListener('click', function() {
                if (sidebar) {
                    sidebar.classList.remove('active');
                }
                this.style.display = 'none';
                document.body.style.overflow = '';
            });
            
            // Fechar o menu ao clicar em um link
            const navLinks = document.querySelectorAll('.sidebar .nav-link');
            if (navLinks.length > 0) {
                navLinks.forEach(link => {
                    link.addEventListener('click', function() {
                        if (window.innerWidth < 992 && sidebar && sidebarOverlay) {
                            sidebar.classList.remove('active');
                            sidebarOverlay.style.display = 'none';
                            document.body.style.overflow = '';
                        }
                    });
                });
            }
            
            // Ajustar o menu ao redimensionar a tela
            window.addEventListener('resize', function() {
                if (window.innerWidth >= 992 && sidebar && sidebarOverlay) {
                    sidebar.classList.remove('active');
                    sidebarOverlay.style.display = 'none';
                    document.body.style.overflow = '';
                }
            });
        }
        
        // Adicionar evento de logout
        document.getElementById('logoutBtn')?.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Logout solicitado, removendo token...');
            localStorage.removeItem('token');
            window.location.href = 'login.html?logout=true';
        });
        
        // Inicialização da página
        document.addEventListener('DOMContentLoaded', async function() {
            // Carregar o menu lateral
            if (typeof loadSidebar === 'function') {
                loadSidebar();
            } else {
                console.error('Função loadSidebar não encontrada');
            }
            console.log('Página carregada, verificando autenticação...');
            
            // Verificar autenticação
            const isAuthenticated = await checkAuth();
            if (!isAuthenticated) {
                window.location.href = 'login.html';
                return;
            }
            
            console.log('Usuário autenticado, carregando profissionais...');
            
            // Configurar eventos
            setupEventListeners();
            
            // Carregar profissionais iniciais
            await loadProfissionais();
            
            console.log('Página inicializada com sucesso!');
        });
    </script>
    <script src="js/sidebar.js"></script>
</body>
</html>