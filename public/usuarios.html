<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Usários - Sistema de Gestão Clínica</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="css/sidebar.css" rel="stylesheet">
    <link href="css/theme.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #f0b354;    /* Dourado */
            --primary-hover: #d9a24a;   /* Dourado mais escuro */
            --secondary-color: #041a31; /* Azul Royal */
            --secondary-hover: #031425; /* Azul Royal mais escuro */
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --border-color: rgba(240, 179, 84, 0.2);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover, .btn-primary:focus {
            background-color: var(--primary-hover);
            border-color: var(--primary-hover);
        }
        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .table-hover > tbody > tr:hover {
            background-color: #f5f7fa !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
        }
        
        .page-title {
            color: var(--secondary-color);
            font-weight: 600;
        }
        
        .table > :not(:last-child) > :last-child > * {
            border-bottom-color: #e0e0e0;
            border-bottom-width: 2px;
        }
        
        .table-striped > tbody > tr:nth-of-type(odd) {
            background-color: #f9fafb;
        }
        
        .table-striped > tbody > tr:nth-of-type(even) {
            background-color: #ffffff;
        }
        
        .table > thead th {
            border-top: none;
            border-bottom: 2px solid #ced4da !important;
            padding: 1.1rem 1.5rem;
            font-weight: 700 !important;
            color: #000000 !important;
            background-color: #e9ecef !important;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background-color: #f8f9fa;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
        }
        
        .table > tbody > tr {
            border-bottom: 1px solid #e8e9ea;
            transition: background-color 0.15s ease;
        }
        
        .table > tbody > tr:hover {
            background-color: #f8f9fa;
        }
        
        .table td {
            padding: 1.1rem 1.5rem;
            vertical-align: middle;
            border-top: 1px solid #f0f0f0;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
            justify-content: center;
        }
        
        .action-buttons .btn {
            width: 32px;
            height: 32px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            border-radius: 4px;
            transition: all 0.2s ease;
            margin: 0 2px;
            border-width: 1px;
        }
        
        /* Botão Visualizar - Verde suave */
        .action-buttons .btn-outline-primary {
            color: #2e7d32;
            border-color: #a5d6a7;
            background-color: #e8f5e9;
        }
        
        .action-buttons .btn-outline-primary:hover {
            background-color: #2e7d32;
            color: white;
            border-color: #2e7d32;
        }
        
        /* Botão Editar - Amarelo suave */
        .action-buttons .btn-outline-warning {
            color: #ed6c02;
            border-color: #ffe082;
            background-color: #fff8e1;
        }
        
        .action-buttons .btn-outline-warning:hover {
            background-color: #ed6c02;
            color: white;
            border-color: #ed6c02;
        }
        
        /* Botão Excluir - Vermelho suave */
        .action-buttons .btn-outline-danger {
            color: #d32f2f;
            border-color: #ffcdd2;
            background-color: #ffebee;
        }
        
        .action-buttons .btn-outline-danger:hover {
            background-color: #d32f2f;
            color: white;
            border-color: #d32f2f;
        }
        
        /* Estilo para o dropdown de sugestões */
        .search-container {
            position: relative;
            width: 100%;
        }
        
        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            display: none;
            margin-top: 2px;
        }
        
        .search-suggestions.show {
            display: block;
        }
        
        .suggestion-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: background-color 0.2s;
        }
        
        .suggestion-item:hover {
            background-color: #f8f9fa;
        }
        
        .suggestion-item .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #f0b354;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .suggestion-item .user-info {
            flex: 1;
            min-width: 0;
        }
        
        .suggestion-item .user-name {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .suggestion-item .user-details {
            font-size: 0.8rem;
            color: #6c757d;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .suggestion-item.highlighted {
            background-color: #f0f0f0;
        }
        
        .badge {
            font-weight: 500;
            padding: 0.4em 0.75em;
        }
        
        .badge-success {
            background-color: #28a74520;
            color: #28a745;
        }
        
        .badge-warning {
            background-color: #ffc10720;
            color: #ffc107;
        }
        
        .badge-danger {
            background-color: #dc354520;
            color: #dc3545;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .page-header {
                flex-direction: column;
                align-items: flex-start !important;
            }
            
            .page-actions {
                margin-top: 1rem;
                width: 100%;
            }
            
            .btn-add-user {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    
    <!-- Botão de toggle para o menu lateral em dispositivos móveis -->
    <button class="btn btn-light d-md-none position-fixed" id="sidebarToggle" style="z-index: 1050; top: 10px; left: 10px;">
        <i class="bi bi-list"></i>
    </button>
    
    <!-- Overlay para fechar o menu ao clicar fora -->
    <div class="sidebar-overlay"></div>
    
    <!-- Conteúdo Principal -->
    <div class="main-content">
        <div class="container-fluid p-0">
            <!-- Cabeçalho da Página -->
            <div class="page-header mb-4">
                <div class="row align-items-center mb-3">
                    <div class="col-12 col-md-6 mb-3 mb-md-0">
                        <div>
                            <h1 class="page-title fw-bolder" style="font-weight: 800 !important; margin-bottom: 10px;">
                                <i class="bi bi-people-fill me-2" style="color: #f0b354;"></i>Usuários
                            </h1>
                            <p class="text-muted mb-0 mt-2">Gerencie os usuários do seu negócio</p>
                        </div>
                    </div>
                    <div class="col-12 col-md-6">
                        <div class="d-flex flex-wrap justify-content-md-end" style="gap: 10px;">
                            <div class="input-group" style="width: 250px;">
                            <span class="input-group-text bg-white border-end-0">
                                <i class="bi bi-search"></i>
                            </span>
                            <input type="text" id="searchInput" class="form-control border-start-0" placeholder="Buscar por nome, CPF ou e-mail...">
                        </div>
                            <button type="button" class="btn btn-primary d-flex align-items-center" id="addUserBtn" style="height: 38px;">
                                <i class="bi bi-plus-lg me-1"></i>
                                <span class="d-none d-sm-inline">Novo Usuário</span>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="border-bottom mt-3"></div>
            </div>
            
            <!-- Card da Tabela de Users -->
            <div class="card">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <style>
                            #usersTable {
                                --bs-table-bg: transparent;
                                --bs-table-striped-bg: #f8f9fa;
                                --bs-table-hover-bg: #f1f3f5;
                                width: 100%;
                                margin-bottom: 1rem;
                                color: #212529;
                                vertical-align: middle;
                                border-color: #e9ecef;
                                table-layout: fixed;
                            }
                            #usersTable th,
                            #usersTable td {
                                padding: 0.75rem 1rem;
                                border-bottom: 1px solid #e9ecef;
                                vertical-align: middle;
                                white-space: nowrap;
                                overflow: hidden;
                                text-overflow: ellipsis;
                            }
                            #usersTable th {
                                background-color: #f8f9fa;
                                font-weight: 600;
                                text-transform: uppercase;
                                font-size: 0.8rem;
                                letter-spacing: 0.5px;
                                color: #495057;
                                position: sticky;
                                top: 0;
                                z-index: 10;
                                border-bottom: 2px solid #e9ecef;
                            }
                            #usersTable tbody tr:hover {
                                background-color: rgba(0, 0, 0, 0.02);
                            }
                            #usersTable .action-buttons {
                                display: flex;
                                gap: 0.5rem;
                                justify-content: flex-end;
                                flex-wrap: nowrap;
                            }
                            @media (max-width: 768px) {
                                #usersTable .action-buttons {
                                    flex-direction: column;
                                    gap: 0.25rem;
                                }
                                #usersTable .action-buttons .btn {
                                    width: 100%;
                                    margin: 0.1rem 0;
                                }
                            }
                        </style>
                        <table class="table mb-0" id="usersTable">
                            <thead>
                                <tr>
                                    <th style="width: 45%;">Nome</th>
                                    <th style="width: 25%;">Perfil</th>
                                    <th style="width: 15%;">Status</th>
                                    <th style="width: 15%; text-align: center;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <!-- Dados serão carregados via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer bg-white d-flex justify-content-between align-items-center">
                    <div class="text-muted small">
                        Mostrando <span id="showingFrom">0</span> a <span id="showingTo">0</span> de <span id="totalUsers">0</span> usuário(s)
                    </div>
                    <nav aria-label="Navegação de páginas">
                        <ul class="pagination pagination-sm mb-0">
                            <!-- A navegação será preenchida dinamicamente pelo JavaScript -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Adicionar/Editar Usuário -->
    <div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addUserModalLabel">Adicionar Novo Usuário</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <form id="userForm">
                    <div class="modal-body">
                        <input type="hidden" id="userId">
                        <div class="mb-3">
                            <label for="userName" class="form-label">Nome Completo</label>
                            <input type="text" class="form-control" id="userName" required>
                        </div>
                        <div class="mb-3">
                            <label for="userEmail" class="form-label">E-mail</label>
                            <input type="email" class="form-control" id="userEmail" required>
                        </div>
                        <div id="passwordFields">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="userPassword" class="form-label">Senha</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="userPassword">
                                        <button class="btn btn-outline-secondary" type="button" id="togglePasswordUser">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">Deixe em branco para manter a senha atual</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="userConfirmPassword" class="form-label">Confirmar Senha</label>
                                    <input type="password" class="form-control" id="userConfirmPassword">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="userProfile" class="form-label">Perfil</label>
                                <select class="form-select" id="userProfile" required>
                                    <option value="ADMIN">Administrador</option>
                                    <option value="USER" selected>Usuário</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="userStatus" class="form-label">Status</label>
                                <select class="form-select" id="userStatus" required>
                                    <option value="ATIVO">Ativo</option>
                                    <option value="INATIVO">Inativo</option>
                                    <option value="BLOQUEADO">Bloqueado</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Salvar Usuário</button>
                    </div>
                </form>
                <script>
                    // Toggle para mostrar/esconder senha
                    document.getElementById('togglePasswordUser').addEventListener('click', function() {
                        const passwordInput = document.getElementById('userPassword');
                        const type = passwordInput.type === 'password' ? 'text' : 'password';
                        passwordInput.type = type;
                        this.querySelector('i').classList.toggle('bi-eye');
                        this.querySelector('i').classList.toggle('bi-eye-slash');
                    });
                </script>
            </div>
        </div>
    </div>

    <!-- Modal Adicionar/Editar Procedimento -->
    <div class="modal fade" id="procedimentoModal" tabindex="-1" aria-labelledby="procedimentoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="procedimentoModalLabel">Adicionar Novo Procedimento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>


    <!-- Modal de Visualização de Usuário -->
    <div class="modal fade" id="viewUserModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalhes do Usuário</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <h6 class="text-muted mb-1">Nome</h6>
                        <p id="viewUserName" class="mb-3">-</p>
                        
                        <h6 class="text-muted mb-1">E-mail</h6>
                        <p id="viewUserEmail" class="mb-3">-</p>
                        
                        <h6 class="text-muted mb-1">Perfil</h6>
                        <p id="viewUserRole" class="mb-3">-</p>
                        
                        <h6 class="text-muted mb-1">Data de Cadastro</h6>
                        <p id="viewUserCreatedAt" class="mb-0">-</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação de Exclusão -->
    <div class="modal fade" id="deleteUserModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmar Exclusão</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <p>Tem certeza que deseja excluir o usuário <strong id="userToDelete"></strong>?</p>
                    <p class="text-danger">Esta ação não pode ser desfeita!</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteUser">Excluir</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    <script src="js/sidebar.js"></script>
    
    <script>
        // Variáveis globais
        let users = [];
        let filteredUsers = [];
        let currentPage = 1;
        const itemsPerPage = 10; // Exibir 10 users por página
        let showInactiveUsers = false;
        
        // Inicialização quando o DOM estiver pronto
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar menu mobile
            setupMobileMenu();
            
            // Inicializar máscaras
            $('#userPhone').mask('(00) 00000-0000');
            $('#userZipCode').mask('00000-000');
            
            // Carregar users
            loadUsers();
            
            // Configurar eventos
            setupEventListeners();
            
            // Inicializar DataTable
            initDataTable();
            
            // Configurar menu mobile
            setupMobileMenu();
            
            // Verificar autenticação
            checkAuth();
        });
        
        // Função para obter o token JWT do localStorage
        function getAuthToken() {
            const token = localStorage.getItem('token');
            console.log('Token recuperado do localStorage:', token ? 'Presente' : 'Ausente');
            if (!token) {
                console.warn('Nenhum token encontrado no localStorage');
        }
        return token;
    }

    // Função para verificar autenticação
    function checkAuth() {
        console.log('Verificando autenticação...');
        const token = getAuthToken();
        
        if (!token) {
            console.warn('Usuário não autenticado, redirecionando para login...');
            window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.pathname);
            return false;
        }
        
        try {
            // Verificar se o token é válido (opcional, pode ser verificado no servidor)
            const payload = JSON.parse(atob(token.split('.')[1]));
            const isExpired = payload.exp * 1000 < Date.now();
            
            if (isExpired) {
                console.warn('Token expirado, redirecionando para login...');
                localStorage.removeItem('token');
                window.location.href = 'login.html?session=expired';
                return false;
            }
            
            console.log('Usuário autenticado com sucesso');
            return true;
        } catch (error) {
            console.error('Erro ao verificar token:', error);
            localStorage.removeItem('token');
            window.location.href = 'login.html?error=invalid_token';
            return false;
        }
    }

        // Função para configurar o menu mobile
        function setupMobileMenu() {
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.getElementById('sidebar');
            
            if (sidebarToggle && sidebar) {
                sidebarToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('show');
                });
            }
        }

        // Função para fazer requisições autenticadas
        async function fetchWithAuth(url, options = {}) {
            const token = getAuthToken();
            
            console.log('Token recuperado do localStorage:', token ? 'Presente' : 'Ausente');
            
            // Adicionar o token ao cabeçalho de autorização
            const headers = {
                'Content-Type': 'application/json',
                'Cache-Control': 'no-cache',
                'Pragma': 'no-cache',
                ...options.headers
            };
            
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            
            // Adicionar timestamp para evitar cache
            const separator = url.includes('?') ? '&' : '?';
            const timestamp = `_t=${new Date().getTime()}`;
            const urlWithTimestamp = `${url}${separator}${timestamp}`;
            
            console.log(`Enviando requisição para: ${urlWithTimestamp}`);
            console.log('Método:', options.method || 'GET');
            console.log('Headers:', JSON.stringify(headers, null, 2));
            
            try {
                const response = await fetch(urlWithTimestamp, {
                    ...options,
                    headers,
                    cache: 'no-store' // Evitar cache
                });
                
                console.log('Resposta recebida:', response.status, response.statusText);
                
                if (!response.ok) {
                    let errorMessage = `Erro na requisição: ${response.status} ${response.statusText}`;
                    let errorDetails = {};
                    
                    try {
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            errorDetails = await response.json();
                            console.error('Detalhes do erro:', errorDetails);
                            if (errorDetails.message) {
                                errorMessage = errorDetails.message;
                            }
                        } else {
                            const text = await response.text();
                            console.error('Resposta do servidor (não JSON):', text);
                            errorMessage = text || errorMessage;
                        }
                    } catch (e) {
                        console.error('Erro ao processar resposta de erro:', e);
                    }
                    
                    const error = new Error(errorMessage);
                    error.status = response.status;
                    error.details = errorDetails;
                    throw error;
                }
                
                // Verificar se a resposta tem conteúdo antes de tentar fazer parse como JSON
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    return await response.json();
                } else {
                    return await response.text();
                }
            } catch (error) {
                console.error('Erro na requisição:', error);
                Swal.fire({
                    title: 'Erro!',
                    text: error.message || 'Ocorreu um erro ao processar sua solicitação',
                    icon: 'error',
                    confirmButtonColor: '#f0b354'
                });
                throw error;
            }
        }

        // Função para carregar usuários da API
        async function loadUsers() {
            try {
                console.log('Iniciando carregamento de usuários...');
                
                // Esconder a tabela enquanto carrega
                const tableContainer = document.querySelector('.table-responsive');
                
                try {
                    // Buscar usuários da API
                    const response = await fetchWithAuth('/api/usuarios');
                    
                    if (response && Array.isArray(response)) {
                        // Mapear apenas os campos necessários
                        users = response.map(user => ({
                            id: user.id,
                            name: user.name || 'Não informado',
                            email: user.email || 'N/A',
                            role: user.role || 'USER',
                            createdAt: user.createdAt,
                            criadoEm: user.createdAt ? new Date(user.createdAt).toLocaleDateString('pt-BR') : 'N/A'
                        }));
                        
                        // Renderizar a tabela e atualizar a paginação
                        renderUsersTable();
                        updatePagination();
                        return; // Sai da função se tudo der certo
                    }
                    
                    throw new Error('Resposta inválida da API');
                    
                } catch (error) {
                    // Se for erro de permissão (403)
                    if (error.status === 403 || (error.response && error.response.status === 403)) {
                        // Esconder o conteúdo da página
                        document.querySelector('.main-content').innerHTML = `
                            <div class="container">
                                <div class="row justify-content-center mt-5">
                                    <div class="col-md-8 text-center">
                                        <div class="card border-0 shadow-sm">
                                            <div class="card-body p-5">
                                                <i class="bi bi-shield-lock text-warning mb-4" style="font-size: 4rem;"></i>
                                                <h3 class="mb-3">Acesso Restrito</h3>
                                                <p class="text-muted mb-4">
                                                    Você não possui permissão para acessar esta área.
                                                    Apenas administradores podem gerenciar usuários do sistema.
                                                </p>
                                                <a href="dashboard.html" class="btn btn-primary">
                                                    <i class="bi bi-house-door me-2"></i>Voltar ao Início
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>`;

                        // Mostrar alerta
                        Swal.fire({
                            title: 'Acesso Restrito',
                            html: `
                                <div class="text-center">
                                    <i class="bi bi-shield-lock text-warning" style="font-size: 4rem; margin-bottom: 1rem;"></i>
                                    <p>Você não possui permissão para acessar esta área do sistema.</p>
                                    <p class="text-muted">Entre em contato com o administrador para solicitar acesso.</p>
                                </div>
                            `,
                            confirmButtonText: 'Voltar ao Início',
                            confirmButtonColor: '#f0b354',
                            allowOutsideClick: false,
                            allowEscapeKey: false
                        }).then((result) => {
                            if (result.isConfirmed) {
                                window.location.href = 'dashboard.html';
                            }
                        });
                        
                        return; // Sai sem mostrar erro no console
                    }
                    
                    // Se for outro tipo de erro, lança para ser capturado pelo catch externo
                    throw error;
                }
                
            } catch (error) {
                console.error('Erro ao carregar usuários:', error);
                
                // Mostrar mensagem de erro genérica
                const errorMessage = 'Ocorreu um erro ao carregar a lista de usuários. Por favor, tente novamente mais tarde.';
                
                // Atualizar a interface com mensagem de erro
                const tableContainer = document.querySelector('.table-responsive');
                if (tableContainer) {
                    tableContainer.innerHTML = `
                        <div class="text-center p-5">
                            <i class="bi bi-exclamation-triangle text-danger" style="font-size: 4rem;"></i>
                            <h3 class="mt-3">Erro ao carregar</h3>
                            <p class="text-muted">${errorMessage}</p>
                            <button onclick="window.location.reload()" class="btn btn-primary mt-3">
                                <i class="bi bi-arrow-clockwise me-2"></i>Tentar Novamente
                            </button>
                        </div>
                    `;
                }
            }
        }
        
        // Função para renderizar a tabela de usuários
        function renderUsersTable() {
            const tbody = document.getElementById('usersTableBody');
            if (!tbody) return;
            
            // Limpar a tabela
            tbody.innerHTML = '';
            
            try {
                // Verificar se existem usuários para exibir
                if (!users || users.length === 0) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td colspan="3" class="text-center py-3">
                            Nenhum usuário encontrado.
                        </td>
                    `;
                    tbody.appendChild(tr);
                    return;
                }

                // Mostrar todos os usuários
                filteredUsers = [...users];
                const totalFilteredUsers = filteredUsers.length;
                console.log(`Total de usuários encontrados: ${totalFilteredUsers}`);
                
                // Calcular índices para a paginação
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                const paginatedUsers = filteredUsers.slice(startIndex, endIndex);
                
                // Atualizar contadores na interface
                updatePagination();
                
                // Exibir apenas os usuários da página atual
                paginatedUsers.forEach(user => {
                    const tr = document.createElement('tr');
                    
                    // Mapear nomes dos perfis
                    const roleNome = {
                        'ADMIN': 'Administrador',
                        'USER': 'Usuário',
                        'PROFISSIONAL': 'Profissional'
                    }[user.role] || user.role;
                    
                    // Mapear status com valor padrão para status indefinido
                    const status = user.status || 'ATIVO';
                    const statusInfo = {
                        'ATIVO': { class: 'success', label: 'Ativo' },
                        'INATIVO': { class: 'secondary', label: 'Inativo' },
                        'BLOQUEADO': { class: 'danger', label: 'Bloqueado' }
                    }[status] || { class: 'secondary', label: status };
                    
                    // Formatando a data de criação
                    const createdAt = user.createdAt ? new Date(user.createdAt).toLocaleDateString('pt-BR') : 'N/A';
                    
                    // Criar a linha da tabela
                    tr.innerHTML = `
                        <td>
                            <div class="d-flex flex-column">
                                <span>${user.name || 'Não informado'}</span>
                                <small class="text-muted">${user.email || 'N/A'}</small>
                            </div>
                        </td>
                        <td>${roleNome}</td>
                        <td><span class="badge bg-${statusInfo.class}">${statusInfo.label}</span></td>
                        <td class="text-center">
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-outline-primary view-user" data-id="${user.id}" title="Visualizar">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-warning edit-user" data-id="${user.id}" title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-user" 
                                        data-id="${user.id}" 
                                        data-name="${(user.name || '').replace(/"/g, '&quot;')}" 
                                        title="Excluir">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>`;
                    
                    tbody.appendChild(tr);
                });
                
                // Adicionar eventos aos botões
                addUserButtonEvents();
                
            } catch (error) {
                console.error('Erro ao renderizar a tabela de usuários:', error);
                
                // Mostrar mensagem de erro na interface
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td colspan="4" class="text-center text-danger py-3">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        Ocorreu um erro ao carregar os usuários. Por favor, tente novamente.
                    </td>
                `;
                tbody.appendChild(tr);
            }
        }
        
        // Função auxiliar para formatar telefone
        function formatarTelefone(telefone) {
            if (!telefone) return 'N/A';
            // Remove tudo que não for dígito
            const numeros = telefone.replace(/\D/g, '');
            
            // Formatação para celular (11 dígitos) com DDD
            if (numeros.length === 11) {
                return `(${numeros.substring(0, 2)}) ${numeros.substring(2, 7)}-${numeros.substring(7)}`;
            }
            // Formatação para telefone fixo (10 dígitos) com DDD
            if (numeros.length === 10) {
                return `(${numeros.substring(0, 2)}) ${numeros.substring(2, 6)}-${numeros.substring(6)}`;
            }
            // Retorna o número sem formatação se não atender aos padrões
            return telefone;
        }
        
        // Função para formatar CPF (usada em outros lugares do código)
        function formatCPF(cpf) {
            if (!cpf) return 'N/A';
            // Remove tudo que não for dígito
            const numeros = cpf.replace(/\D/g, '');
            // Aplica a formatação do CPF: 000.000.000-00
            return numeros.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
        }
        
        // Função para obter a classe do badge de status (usada em outros lugares do código)
        function getStatusBadgeClass(status) {
            if (!status) return 'bg-secondary';
            switch(status.toUpperCase()) {
                case 'ATIVO':
                case 'ACTIVE':
                    return 'bg-success';
                case 'INATIVO':
                case 'INACTIVE':
                    return 'bg-secondary';
                case 'PENDENTE':
                case 'PENDING':
                    return 'bg-warning';
                case 'BLOQUEADO':
                case 'BLOCKED':
                    return 'bg-danger';
                default:
                    return 'bg-secondary';
            }
        }
        
        // Função para obter o texto do status (usada em outros lugares do código)
        function getStatusText(status) {
            if (!status) return 'Desconhecido';
            
            const statusMap = {
                'ATIVO': 'Ativo',
                'ACTIVE': 'Ativo',
                'INATIVO': 'Inativo',
                'INACTIVE': 'Inativo',
                'PENDENTE': 'Pendente',
                'PENDING': 'Pendente',
                'BLOQUEADO': 'Bloqueado',
                'BLOCKED': 'Bloqueado'
            };
            
            return statusMap[status.toUpperCase()] || 'Desconhecido';
        }
        
        // Função para configurar eventos dos botões da tabela
        function addUserButtonEvents() {
            // Botão de edição
            document.querySelectorAll('.edit-user').forEach(button => {
                button.addEventListener('click', function() {
                    const userId = this.getAttribute('data-id');
                    editUser(userId);
                });
            });
            
            // Botão de exclusão
            document.querySelectorAll('.delete-user').forEach(button => {
                button.addEventListener('click', function() {
                    const userId = this.getAttribute('data-id');
                    const userName = this.getAttribute('data-name') || 'este usuário';
                    showDeleteConfirmation(userId, userName);
                });
            });
            
            // Botão de visualização
            document.querySelectorAll('.view-user').forEach(button => {
                button.addEventListener('click', function() {
                    const userId = this.getAttribute('data-id');
                    viewUser(userId);
                });
            });
            
            // Botão de adicionar usuário
            const addUserBtn = document.getElementById('addUserBtn');
            if (addUserBtn) {
                addUserBtn.addEventListener('click', function() {
                    // Limpar o formulário
                    document.getElementById('userForm').reset();
                    // Alterar título do modal
                    document.getElementById('addUserModalLabel').textContent = 'Adicionar Novo Usuário';
                    // Limpar o ID do usuário (para indicar que é um novo usuário)
                    document.getElementById('userId').value = '';
                    console.log('=== ANTES DE MOSTRAR MODAL ===');
                    console.log('userName antes modal.show():', document.getElementById('userName').value);

                    // Mostrar o modal
                    const modal = new bootstrap.Modal(document.getElementById('addUserModal'));
                    modal.show();

                    console.log('=== DEPOIS DE MOSTRAR MODAL ===');
                    console.log('userName após modal.show():', document.getElementById('userName').value);
                });
            }
            
            // Configurar envio do formulário
            const userForm = document.getElementById('userForm');
            if (userForm) {
                // Remove any existing event listeners to prevent duplicates
                const newForm = userForm.cloneNode(true);
                userForm.parentNode.replaceChild(newForm, userForm);
                
                // Add single submit handler
                newForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    // Disable the submit button to prevent multiple submissions
                    const submitButton = newForm.querySelector('button[type="submit"]');
                    const originalButtonText = submitButton.innerHTML;
                    submitButton.disabled = true;
                    submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Salvando...';
                    
                    try {
                        await saveUser();
                    } catch (error) {
                        console.error('Erro ao salvar usuário:', error);
                        showError('Erro', 'Ocorreu um erro ao salvar o usuário. Tente novamente.');
                    } finally {
                        // Re-enable the button
                        submitButton.disabled = false;
                        submitButton.innerHTML = originalButtonText;
                    }
                });
            }
            
            // Configurar toggle de visibilidade de senha
            const togglePassword = document.querySelector('.toggle-password');
            if (togglePassword) {
                togglePassword.addEventListener('click', function() {
                    const passwordInput = document.getElementById('userPassword');
                    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordInput.setAttribute('type', type);
                    this.querySelector('i').classList.toggle('bi-eye');
                    this.querySelector('i').classList.toggle('bi-eye-slash');
                });
            }
        }
        
        // Função para visualizar usuário
        // Função para visualizar detalhes de um usuário
        async function viewUser(userId) {
            try {
                console.log(`Carregando detalhes do usuário ID: ${userId}`);
                const response = await fetchWithAuth(`/api/usuarios/${userId}`);
                
                if (response && (response.data || response.id)) {
                    const user = response.data || response;
                    console.log('Dados do usuário recebidos:', user);
                    
                    // Mapear nomes dos perfis
                    const roleNome = {
                        'ADMIN': 'Administrador',
                        'USER': 'Usuário',
                        'PROFISSIONAL': 'Profissional'
                    }[user.role] || user.role;
                    
                    // Formatar data de criação
                    const dataCriacao = user.createdAt ? new Date(user.createdAt).toLocaleDateString('pt-BR') : 'N/A';
                    
                    // Preencher o modal de visualização
                    document.getElementById('viewUserName').textContent = user.name || 'Não informado';
                    document.getElementById('viewUserEmail').textContent = user.email || 'N/A';
                    document.getElementById('viewUserRole').textContent = roleNome;
                    document.getElementById('viewUserCreatedAt').textContent = dataCriacao;
                    
                    // Mostrar o modal
                    const viewUserModal = new bootstrap.Modal(document.getElementById('viewUserModal'));
                    viewUserModal.show();
                    
                } else {
                    throw new Error('Dados do usuário não encontrados na resposta');
                }
            } catch (error) {
                console.error('Erro ao carregar detalhes do usuário:', error);
                showError('Erro', error.message || 'Não foi possível carregar os dados do usuário');
            }
        }
        
        // Função para carregar detalhes do usuário para edição
        async function loadUserDetails(userId) {
            try {
                console.log(`Carregando detalhes do usuário ID: ${userId}`);
                
                // Mostrar loading
                const loadingSwal = Swal.fire({
                    title: 'Carregando...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                
                try {
                    const response = await fetchWithAuth(`/api/usuarios/${userId}`, {
                        headers: {
                            'Cache-Control': 'no-cache',
                            'Pragma': 'no-cache'
                        }
                    });
                    
                    // Fechar loading
                    await loadingSwal.close();
                    
                    if (!response) {
                        throw new Error('Resposta vazia do servidor');
                    }
                    
                    // Verificar se a resposta tem a estrutura esperada
                    const user = response.data || response;
                    console.log('Dados do usuário recebidos para edição:', user);

                    if (!user.id && !user._id) {
                        throw new Error('Dados do usuário inválidos na resposta');
                    }

                    // Preencher o formulário com os dados do usuário
                    const userIdValue = user.id || user._id || '';
                    const userNameValue = user.name || user.nome || '';
                    const userEmailValue = user.email || '';

                    console.log('=== INÍCIO DO PREENCHIMENTO DO FORMULÁRIO ===');
                    console.log('User data received:', user);
                    console.log('Extracted values:', {
                        userIdValue: userIdValue,
                        userNameValue: userNameValue,
                        userEmailValue: userEmailValue
                    });

                    const userIdField = document.getElementById('userId');
                    const userNameField = document.getElementById('userName');
                    const userEmailField = document.getElementById('userEmail');

                    console.log('Campos encontrados:', {
                        userIdField: !!userIdField,
                        userNameField: !!userNameField,
                        userEmailField: !!userEmailField
                    });

                    userIdField.value = userIdValue;
                    userNameField.value = userNameValue;
                    userEmailField.value = userEmailValue;

                    console.log('Campo userName após preenchimento:', {
                        element: !!userNameField,
                        value: userNameField ? userNameField.value : 'elemento não encontrado',
                        expectedValue: userNameValue
                    });

                    // Normalizar o valor do perfil para maiúsculo e padronizar
                    const rawRole = user.role || user.perfil || '';
                    let normalizedRole = rawRole.toUpperCase();

                    // Mapeamento de valores possíveis da API para valores do select
                    const roleMapping = {
                        'ADMIN': 'ADMIN',
                        'ADMINISTRADOR': 'ADMIN',
                        'USER': 'USER',
                        'USUARIO': 'USER',
                        'PROFESSIONAL': 'USER', // fallback para profissional
                        'PROFISSIONAL': 'USER'
                    };

                    normalizedRole = roleMapping[normalizedRole] || 'USER';

                    console.log('Role original:', rawRole);
                    console.log('Role normalizado:', normalizedRole);

                    document.getElementById('userProfile').value = normalizedRole;
                    
                    // Ajustar o status para garantir que corresponda ao valor do select
                    const statusSelect = document.getElementById('userStatus');
                    const statusValue = (user.status || 'ATIVO').toUpperCase();
                    
                    // Verificar se o valor existe nas opções do select
                    const statusOptions = Array.from(statusSelect.options).map(opt => opt.value.toUpperCase());
                    const validStatus = statusOptions.includes(statusValue) ? 
                        statusSelect.querySelector(`option[value="${statusValue}"]`) ? 
                        statusValue : 'ATIVO' : 'ATIVO';
                        
                    statusSelect.value = validStatus;
                    console.log('Status definido como:', validStatus);
                    
                    // Alterar título do modal
                    document.getElementById('addUserModalLabel').textContent = 'Editar Usuário';
                    
                    // Mostrar o modal
                    const modal = new bootstrap.Modal(document.getElementById('addUserModal'));
                    modal.show();
                    
                } catch (error) {
                    await loadingSwal.close();
                    throw error;
                }
                
            } catch (error) {
                console.error('Erro ao carregar detalhes do usuário:', error);
                
                let errorMessage = 'Não foi possível carregar os dados do usuário';
                
                if (error.status === 404) {
                    errorMessage = 'Usuário não encontrado';
                } else if (error.status === 401) {
                    errorMessage = 'Sessão expirada. Por favor, faça login novamente.';
                    // Redirecionar para a página de login após 2 segundos
                    setTimeout(() => {
                        window.location.href = 'login.html?session_expired=1';
                    }, 2000);
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                await Swal.fire({
                    title: 'Erro!',
                    text: errorMessage,
                    icon: 'error',
                    confirmButtonColor: '#f0b354'
                });
                
                // Se for erro de autenticação, redirecionar para o login
                if (error.status === 401) {
                    window.location.href = 'login.html?session_expired=1';
                }
            }
        }
        
        // Função para editar usuário
        function editUser(userId) {
            loadUserDetails(userId);
        }
        
        // Função para mostrar confirmação de exclusão
        function showDeleteConfirmation(userId, userName) {
            document.getElementById('userToDelete').textContent = userName;
            
            const modal = new bootstrap.Modal(document.getElementById('deleteUserModal'));
            modal.show();
            
            // Configurar o botão de confirmação
            const confirmBtn = document.getElementById('confirmDeleteUser');
            if (confirmBtn) {
                const originalHandler = confirmBtn.onclick;
                
                confirmBtn.onclick = function() {
                    confirmBtn.onclick = originalHandler; // Restaurar o handler original
                    deleteUser(userId);
                    modal.hide();
                };
            } else {
                console.error('Botão de confirmação não encontrado');
            }
        }
        
        // Função para excluir usuário
        async function deleteUser(userId) {
            try {
                console.log(`Excluindo usuário com ID: ${userId}`);
                
                await fetchWithAuth(`/api/usuarios/${userId}`, {
                    method: 'DELETE'
                });
                
                console.log('Usuário excluído com sucesso');
                
                // Remover o usuário da lista local
                users = users.filter(user => user.id !== parseInt(userId));
                
                // Atualizar a tabela e a paginação
                renderUsersTable();
                updatePagination();
                
                // Mostrar mensagem de sucesso
                showSuccess('Usuário excluído com sucesso!');
                
            } catch (error) {
                console.error('Erro ao excluir usuário:', error);
                showError('Erro', error.message || 'Ocorreu um erro ao excluir o usuário');
            }
        }
        
        // Função para atualizar a exibição dos usuários com paginação
        function updatePagination() {
            const totalUsers = filteredUsers ? filteredUsers.length : 0;
            const totalPages = Math.ceil(totalUsers / itemsPerPage);
            const paginationContainer = document.querySelector('.pagination');
            
            // Atualizar o texto de exibição com a contagem de usuários
            const showingFromEl = document.getElementById('showingFrom');
            const showingToEl = document.getElementById('showingTo');
            const totalUsersEl = document.getElementById('totalUsers');
            
            if (showingFromEl && showingToEl && totalUsersEl) {
                const start = totalUsers > 0 ? ((currentPage - 1) * itemsPerPage) + 1 : 0;
                const end = Math.min(currentPage * itemsPerPage, totalUsers);
                
                showingFromEl.textContent = start;
                showingToEl.textContent = end;
                totalUsersEl.textContent = totalUsers;
            }
            
            // Atualizar controles de paginação
            if (paginationContainer) {
                let paginationHTML = '';
                
                // Botão Anterior
                paginationHTML += `
                    <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                        <a class="page-link" href="#" id="prevPage">Anterior</a>
                    </li>
                `;
                
                // Números das páginas
                let startPage = Math.max(1, currentPage - 2);
                let endPage = Math.min(totalPages, startPage + 4);
                
                if (endPage - startPage < 4 && totalPages > 4) {
                    startPage = Math.max(1, endPage - 4);
                }
                
                for (let i = startPage; i <= endPage; i++) {
                    paginationHTML += `
                        <li class="page-item ${i === currentPage ? 'active' : ''}">
                            <a class="page-link page-number" href="#" data-page="${i}">${i}</a>
                        </li>
                    `;
                }
                
                // Botão Próximo
                paginationHTML += `
                    <li class="page-item ${currentPage >= totalPages ? 'disabled' : ''}">
                        <a class="page-link" href="#" id="nextPage">Próximo</a>
                    </li>
                `;
                
                paginationContainer.innerHTML = paginationHTML;
                paginationContainer.style.display = totalPages > 1 ? 'flex' : 'none';
                
                // Adicionar eventos aos botões de paginação
                document.getElementById('prevPage')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (currentPage > 1) {
                        currentPage--;
                        renderUsersTable();
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                });
                
                document.getElementById('nextPage')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (currentPage < totalPages) {
                        currentPage++;
                        renderUsersTable();
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                });
                
                document.querySelectorAll('.page-number').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const page = parseInt(e.target.getAttribute('data-page'));
                        if (page !== currentPage) {
                            currentPage = page;
                            renderUsersTable();
                            window.scrollTo({ top: 0, behavior: 'smooth' });
                        }
                    });
                });
            }
        }
        
        // Função para obter a classe CSS do badge de status
        function getStatusBadgeClass(status) {
            const statusClasses = {
                'ACTIVE': 'bg-success',
                'INACTIVE': 'bg-secondary',
                'PENDING': 'bg-warning text-dark',
                'BLOCKED': 'bg-danger'
            };
            return statusClasses[status] || 'bg-secondary';
        }

        // Função para obter o texto do status
        function getStatusText(status) {
            const statusTexts = {
                'ACTIVE': 'Ativo',
                'INACTIVE': 'Inativo',
                'PENDING': 'Pendente',
                'BLOCKED': 'Bloqueado'
            };
            return statusTexts[status] || status;
        }

        // Função para formatar data
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            
            const options = { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return 'Data inválida';
                
                // Verificar se a data tem hora definida
                const hasTime = dateString.includes('T') || dateString.includes(' ');
                
                if (hasTime) {
                    return date.toLocaleString('pt-BR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } else {
                    return date.toLocaleDateString('pt-BR');
                }
            } catch (e) {
                console.error('Erro ao formatar data:', e);
                return dateString;
            }
        }
        
        // Função para configurar os listeners de eventos
        function setupEventListeners() {
            // Removendo o manipulador de evento duplicado para o formulário
            // O manipulador principal já está configurado acima
            
            // Botão de novo usuário (barra lateral)
            const newUserBtn = document.querySelector('.btn-add-user');
            if (newUserBtn) {
                newUserBtn.addEventListener('click', function() {
                    resetUserForm();
                    document.getElementById('addUserModalLabel').textContent = 'Adicionar Novo Usuário';
                });
            }
            
            // Botão de novo usuário (ao lado da busca)
            const addUserBtn = document.getElementById('addUserBtn');
            if (addUserBtn) {
                addUserBtn.addEventListener('click', function() {
                    resetUserForm();
                    const modal = new bootstrap.Modal(document.getElementById('addUserModal'));
                    modal.show();
                });
            }
            
            // Busca na tabela
            const searchInput = document.getElementById('searchInput');
            let debounceTimer;
            
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value.trim();
                    clearTimeout(debounceTimer);
                    
                    debounceTimer = setTimeout(() => {
                        if (searchTerm.length > 1 || searchTerm.length === 0) {
                            filterUsers(searchTerm);
                        }
                    }, 300);
                });
                
                // Pesquisar ao pressionar Enter
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const searchTerm = this.value.trim();
                        if (searchTerm.length > 0) {
                            filterUsers(searchTerm);
                        }
                    }
                });
            }
        }
        

        // Função para filtrar usuários na tabela
        function filterUsers(searchTerm) {
            currentPage = 1; // Reset para a primeira página ao filtrar
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';
            
            // Se não houver termo de busca, exibe todos os usuários ativos
            if (!searchTerm || searchTerm.trim() === '') {
                renderUsersTable();
                return;
            }
            
            // Filtra os usuários com base no termo de busca
            const filteredUsers = users.filter(user => {
                const searchLower = searchTerm.toLowerCase();
                return (
                    (user.nome && user.nome.toLowerCase().includes(searchLower)) ||
                    (user.email && user.email.toLowerCase().includes(searchLower)) ||
                    (user.cpf && user.cpf.includes(searchTerm)) ||
                    (user.telefone && user.telefone.includes(searchTerm))
                );
            });
            
            // Se não encontrar resultados
            if (filteredUsers.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td colspan="5" class="text-center py-4">
                        <div class="text-muted">
                            <i class="bi bi-search display-5 d-block mb-2"></i>
                            Nenhum usuário encontrado para "${searchTerm}"
                        </div>
                    </td>`;
                tbody.appendChild(tr);
                
                // Atualizar informações de paginação
                document.getElementById('showingFrom').textContent = 0;
                document.getElementById('showingTo').textContent = 0;
                document.getElementById('totalUsers').textContent = 0;
                
                return;
            }
            
            // Exibe os resultados da busca
            filteredUsers.forEach(user => {
                const tr = document.createElement('tr');
                const nome = user.nome || 'Não informado';
                const email = user.email || 'N/A';
                
                tr.innerHTML = `
                    <td>#${String(user.id).padStart(4, '0')}</td>
                    <td>
                        <div>
                            <h6 class="mb-0">${nome}</h6>
                            <small class="text-muted d-block text-truncate" style="max-width: 250px;" title="${email}">${email}</small>
                        </div>
                    </td>
                    <td>${user.telefone || 'N/A'}</td>
                    <td style="text-align: center;">
                        <span class="badge ${getStatusBadgeClass(user.status)}">
                            ${getStatusText(user.status)}
                        </span>
                    </td>
                    <td style="text-align: center;">
                        <div class="action-buttons justify-content-center">
                            <button class="btn btn-sm btn-outline-primary view-user" data-id="${user.id}" title="Visualizar">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-warning edit-user" data-id="${user.id}" title="Editar">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger delete-user" data-id="${user.id}" data-name="${(user.nome || '').replace(/"/g, '&quot;')}" title="Excluir">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>`;
                tbody.appendChild(tr);
            });
            
            // Atualizar informações de paginação
            document.getElementById('showingFrom').textContent = 1;
            document.getElementById('showingTo').textContent = filteredUsers.length;
            document.getElementById('totalUsers').textContent = filteredUsers.length;
            
            // Adicionar eventos aos botões
            addUserButtonEvents();
        }
        
        // Função para salvar usuário (adicionar ou atualizar)
        async function saveUser() {
            const id = document.getElementById('userId').value;
            const nome = document.getElementById('userName').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            const password = document.getElementById('userPassword').value;
            const confirmPassword = document.getElementById('userConfirmPassword').value;
            const role = document.getElementById('userProfile').value;
            const status = document.getElementById('userStatus').value;

            console.log('=== INÍCIO DO SAVE USER ===');
            console.log('Valores do formulário:', {
                id,
                nome,
                email,
                role,
                status,
                hasPassword: !!password,
                passwordLength: password ? password.length : 0
            });

            // Validações
            if (!nome) {
                showError('Erro de Validação', 'O nome é obrigatório.');
                return;
            }

            if (!email) {
                showError('Erro de Validação', 'O e-mail é obrigatório.');
                return;
            }

            if (!id && !password) {
                showError('Erro de Validação', 'A senha é obrigatória para novo usuário.');
                return;
            }

            if (password && password.length < 6) {
                showError('Erro de Validação', 'A senha deve ter no mínimo 6 caracteres.');
                return;
            }

            if (password && password !== confirmPassword) {
                showError('Erro de Validação', 'As senhas não conferem.');
                return;
            }

            try {
                // Garantir que o status seja uma string e esteja em maiúsculas
                const userStatus = status ? String(status).toUpperCase() : 'ATIVO';

                console.log('=== DADOS DO FORMULÁRIO ===');
                console.log('ID do usuário:', id);
                console.log('Nome:', nome);
                console.log('Email:', email);
                console.log('Perfil:', role);
                console.log('Status (antes):', status);
                console.log('Status (processado):', userStatus);

                let response;
                let method;
                let url = '/api/usuarios';

                if (id) {
                    // Atualizar usuário existente
                    method = 'PUT';
                    url += `/${id}`;
                } else {
                    method = 'POST';
                }

                console.log('Enviando requisição para:', url);
                console.log('Método:', method);

                // Criar objeto JSON para envio
                const jsonData = {
                    name: nome,
                    email: email,
                    role: role,
                    status: userStatus
                };

                // Adicionar senha apenas se foi fornecida
                if (password && password.trim() !== '') {
                    jsonData.password = password;
                    console.log('Senha será incluída na atualização');
                } else {
                    console.log('Senha não será incluída na atualização');
                }

                console.log('Dados JSON que serão enviados:', JSON.stringify(jsonData, null, 2));

                try {
                    // Usar fetchWithAuth que já configura corretamente os headers JSON
                    response = await fetchWithAuth(url, {
                        method,
                        body: JSON.stringify(jsonData)
                    });

                    console.log('=== RESPOSTA BRUTA DA API ===');
                    console.log('Resposta da API recebida:', response);
                    console.log('Tipo da resposta:', typeof response);

                    // fetchWithAuth já retorna o JSON processado ou lança erro
                    // Se chegamos aqui, significa que foi sucesso
                    const responseData = response;
                    console.log('=== DADOS PROCESSADOS ===');
                    console.log('Dados da resposta:', responseData);
                    console.log('Usuário salvo com sucesso:', responseData);

                    // Verificação adicional: comparar dados enviados com dados recebidos
                    console.log('=== COMPARAÇÃO ===');
                    console.log('Dados enviados - Nome:', jsonData.name);
                    console.log('Dados recebidos - Nome:', responseData.name);
                    console.log('Nomes são iguais?', jsonData.name === responseData.name);

                    // Verificação adicional no frontend
                    if (jsonData.name !== responseData.name) {
                        console.warn('⚠️ ATENÇÃO: Nome enviado diferente do nome recebido!');
                        console.warn('Isso pode indicar problema na API');
                    } else {
                        console.log('✅ Nomes consistentes entre envio e recebimento');
                    }

                    // Fechar o modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addUserModal'));
                    if (modal) {
                        modal.hide();
                    }

                    // Mostrar mensagem de sucesso
                    showSuccess('Usuário salvo com sucesso!');

                    // Recarregar a lista de usuários
                    await loadUsers();

                    console.log('Lista de usuários recarregada após salvar');

                    // Forçar atualização da tabela mesmo se os dados forem os mesmos
                    console.log('Forçando atualização da tabela...');
                    renderUsersTable();

                    if (!id) {
                        document.getElementById('userForm').reset();
                    }
                } catch (error) {
                    console.error('Erro ao processar a resposta:', error);
                    throw error;
                }

            } catch (error) {
                console.error('Erro ao salvar usuário:', error);
                const errorMessage = error.message || 'Ocorreu um erro ao salvar o usuário';
                showError('Erro', errorMessage);
            }
        }
        
        // Função para resetar o formulário de usuário
        function resetUserForm() {
            const form = document.getElementById('userForm');
            form.reset();
            document.getElementById('userId').value = '';
            document.getElementById('addUserModalLabel').textContent = 'Adicionar Novo Usuário';
            
            // Limpar mensagens de validação
            const validationMessages = form.querySelectorAll('.invalid-feedback');
            validationMessages.forEach(msg => msg.remove());
            
            const inputs = form.querySelectorAll('.is-invalid');
            inputs.forEach(input => input.classList.remove('is-invalid'));
        }
        
        // Função para mostrar mensagem de sucesso
        function showSuccess(message) {
            Swal.fire({
                title: 'Sucesso!',
                text: message,
                icon: 'success',
                confirmButtonColor: '#f0b354',
                timer: 2000,
                timerProgressBar: true
            });
        }
        
        // Função para mostrar mensagem de erro
        function showError(title, message) {
            Swal.fire({
                title: title,
                text: message,
                icon: 'error',
                confirmButtonColor: '#f0b354'
            });
        }
        
        // Função para configurar a tabela
        function initDataTable() {
            // Configuração da busca
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    filterUsers(searchTerm);
                });
            }
        }

        // Função para inicializar os eventos do menu lateral
        function initSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebarOverlay = document.querySelector('.sidebar-overlay');

            // Toggle do menu lateral
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', function() {
                    if (sidebar) {
                        const isActive = !sidebar.classList.contains('active');
                        sidebar.classList.toggle('active', isActive);
                        if (sidebarOverlay) {
                            sidebarOverlay.style.display = isActive ? 'block' : 'none';
                        }
                        document.body.style.overflow = isActive ? 'hidden' : '';
                    }
                });
            }
            
            // Fecha o menu ao clicar no overlay
            if (sidebarOverlay) {
                sidebarOverlay.addEventListener('click', function() {
                    if (sidebar) {
                        sidebar.classList.remove('active');
                    }
                    this.style.display = 'none';
                    document.body.style.overflow = '';
                });
            }
            
            // Fechar o menu ao clicar em um link
            const navLinks = document.querySelectorAll('.sidebar .nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', function() {
                    if (window.innerWidth < 992) {
                        if (sidebar) sidebar.classList.remove('active');
                        if (sidebarOverlay) sidebarOverlay.style.display = 'none';
                        document.body.style.overflow = '';
                    }
                });
            });
            
            // Ajustar o menu ao redimensionar a tela
            const handleResize = () => {
                if (window.innerWidth >= 992) {
                    if (sidebar) sidebar.classList.remove('active');
                    if (sidebarOverlay) sidebarOverlay.style.display = 'none';
                    document.body.style.overflow = '';
                }
            };
            
            window.addEventListener('resize', handleResize);
            
            // Limpar event listeners quando necessário
            return () => {
                window.removeEventListener('resize', handleResize);
                if (sidebarToggle) {
                    const newToggle = sidebarToggle.cloneNode(true);
                    sidebarToggle.parentNode.replaceChild(newToggle, sidebarToggle);
                }
            };
        }
        
        // Adicionar evento de logout
        function setupLogout() {
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                const handleLogout = (e) => {
                    e.preventDefault();
                    console.log('Logout solicitado, removendo token...');
                    localStorage.removeItem('token');
                    window.location.href = 'login.html?logout=true';
                };
                
                logoutBtn.addEventListener('click', handleLogout);
                
                // Retorna a função para limpeza
                return () => {
                    logoutBtn.removeEventListener('click', handleLogout);
                };
            }
            return () => {}; // Retorna uma função vazia se não houver botão
        }
        
        // Inicialização da página
        document.addEventListener('DOMContentLoaded', async function() {
            // Configurar eventos do menu lateral
            const cleanupSidebar = initSidebar();
            const cleanupLogout = setupLogout();
            
            // Carregar o menu lateral
            if (typeof loadSidebar === 'function') {
                loadSidebar();
            } else {
                console.error('Função loadSidebar não encontrada');
            }
            
            try {
                // Configurar eventos
                setupEventListeners();
                
                // Carregar users iniciais
                loadUsers();
                await loadUsers();
            } catch (error) {
                console.error('Erro durante a inicialização:', error);
                showError('Erro', 'Ocorreu um erro ao carregar a página. Por favor, recarregue.');
            }
            
            console.log('Página inicializada com sucesso!');
        });
    </script>
    <script src="js/sidebar.js"></script>
</body>
</html>
